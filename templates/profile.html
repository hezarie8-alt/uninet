{% extends "base.html" %}

{% block title %}پروفایل کاربری | یونی نت{% endblock %}

{% block content %}
<div class="container" style="max-width: 800px; margin: 2rem auto;">
    
    <!-- Profile Header Card -->
    <div class="form-card" style="text-align: center; margin-bottom: 2rem;">
        <form action="{{ url_for('update_profile') }}" method="POST" enctype="multipart/form-data" id="profile-form">
            {{ update_profile_form.hidden_tag() }}
            
            <div class="profile-pic-wrapper">
                {% if user.profile_pic and user.profile_pic != 'default.jpg' %}
                    <img src="{{ url_for('static', filename='uploads/profile_pics/' + user.profile_pic) }}" class="profile-pic-preview" alt="Profile">
                {% else %}
                    <img src="https://ui-avatars.com/api/?name={{ user.full_name }}&background=00838f&color=fff&size=200" class="profile-pic-preview" alt="Avatar">
                {% endif %}
                
                {% if can_edit %}
                    <label for="file-upload" class="profile-pic-edit">
                        <i class="material-icons" style="font-size: 1.2rem;">camera_alt</i>
                        <input id="file-upload" type="file" name="profile_pic" accept="image/*" style="display: none;" onchange="document.getElementById('profile-form').submit();">
                    </label>
                {% endif %}
            </div>
            
            <h2 style="margin-bottom: 0.25rem;">{{ user.full_name }}</h2>
            <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">شماره دانشجویی: {{ user.student_id }}</p>
            <span class="badge" style="background-color: var(--primary-light); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem;">{{ user.major }}</span>
        </form>
    </div>

    {% if can_edit %}
    <!-- Tabs Container -->
    <div class="form-card" style="padding: 0; overflow: hidden;">
        <div class="profile-tabs" style="padding: 0 1rem; background: var(--surface);">
            <div class="profile-tab active" onclick="switchProfileTab('info')">
                <i class="material-icons">person</i> اطلاعات حساب
            </div>
            <div class="profile-tab" onclick="switchProfileTab('security')">
                <i class="material-icons">security</i> امنیت
            </div>
            <div class="profile-tab" onclick="switchProfileTab('danger')">
                <i class="material-icons">warning</i> خطرناک
            </div>
        </div>

        <!-- Tab: Info -->
        <div id="tab-info" class="tab-content active" style="padding: 2rem;">
            <form method="POST" action="{{ url_for('update_profile') }}">
                {{ update_profile_form.hidden_tag() }}
                <div class="form-group">
                    <label class="form-label">نام و نام خانوادگی</label>
                    {{ update_profile_form.full_name(class="form-control") }}
                </div>
                <div class="form-group">
                    <label class="form-label">رشته تحصیلی</label>
                    {{ update_profile_form.major(class="form-select") }}
                </div>
                <button type="submit" class="btn btn-custom">ذخیره تغییرات</button>
            </form>
        </div>

        <!-- Tab: Security -->
        <div id="tab-security" class="tab-content" style="padding: 2rem;">
            <form method="POST" action="{{ url_for('update_password') }}">
                {{ update_password_form.hidden_tag() }}
                <div class="form-group">
                    <label class="form-label">رمز عبور فعلی</label>
                    {{ update_password_form.current_password(class="form-control", type="password") }}
                </div>
                <div class="form-group">
                    <label class="form-label">رمز عبور جدید</label>
                    {{ update_password_form.new_password(class="form-control", type="password") }}
                </div>
                <div class="form-group">
                    <label class="form-label">تکرار رمز عبور جدید</label>
                    {{ update_password_form.confirm_new_password(class="form-control", type="password") }}
                </div>
                <button type="submit" class="btn btn-custom">تغییر رمز عبور</button>
            </form>
        </div>

        <!-- Tab: Danger -->
        <div id="tab-danger" class="tab-content" style="padding: 2rem;">
            <div style="background-color: rgba(183, 28, 28, 0.05); border: 1px solid var(--error); border-radius: 8px; padding: 1.5rem;">
                <h3 style="color: var(--error); margin-bottom: 0.5rem;">حذف حساب کاربری</h3>
                <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">
                    با حذف حساب کاربری، تمام اطلاعات شما شامل پیام‌ها و برنامه کلاسی به طور کامل پاک خواهد شد. این عمل غیرقابل بازگشت است.
                </p>
                <form method="POST" action="{{ url_for('delete_account') }}" onsubmit="return confirm('آیا مطمئن هستید؟');">
                    {{ delete_account_form.hidden_tag() }}
                    <button type="submit" class="btn" style="background-color: var(--error); color: white;">حذف حساب من</button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block scripts %}
<script>
    function switchProfileTab(tabName) {
        // Hide all contents
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        // Deactivate all tabs
        document.querySelectorAll('.profile-tab').forEach(el => el.classList.remove('active'));
        
        // Activate selected
        document.getElementById('tab-' + tabName).classList.add('active');
        event.target.closest('.profile-tab').classList.add('active');
    }
</script>
{% endblock %}