{% extends "base.html" %}

{% block title %}پروفایل کاربری | یونی نت{% endblock %}

{% block content %}
<div class="container" style="max-width: 800px; margin: 2rem auto;">
    
    <!-- Profile Header Card -->
    <div class="form-card" style="text-align: center; margin-bottom: 2rem;">
        <form action="{{ url_for('update_profile') }}" method="POST" enctype="multipart/form-data" id="profile-form">
            {{ update_profile_form.hidden_tag() }}
            
            <div class="profile-pic-wrapper">
                {% if user.profile_pic and user.profile_pic != 'default.jpg' %}
                    <img src="{{ url_for('static', filename='uploads/profile_pics/' + user.profile_pic) }}?t={{ range(1000) | random }}" class="profile-pic-preview" alt="Profile">
                {% else %}
                    <img src="https://ui-avatars.com/api/?name={{ user.full_name }}&background=00838f&color=fff&size=200" class="profile-pic-preview" alt="Avatar">
                {% endif %}
                
                {% if can_edit %}
                    <label for="file-upload" class="profile-pic-edit">
                        <i class="material-icons" style="font-size: 1.2rem;">camera_alt</i>
                        <input id="file-upload" type="file" name="profile_pic" accept="image/*" style="display: none;" onchange="document.getElementById('profile-form').submit();">
                    </label>
                {% endif %}
            </div>
            
            <h2 style="margin-bottom: 0.25rem;">{{ user.full_name }}</h2>
            <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">شماره دانشجویی: {{ user.student_id }}</p>
            <span class="badge" style="background-color: var(--primary-light); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem;">{{ user.major }}</span>
            
            {% if not can_edit %}
                <div style="margin-top: 1.5rem;">
                    <a href="{{ url_for('chat_main', user_id=user.id) }}" class="btn btn-custom">
                        <i class="material-icons" style="font-size: 1rem; margin-left: 5px;">chat</i>
                        ارسال پیام
                    </a>
                </div>
            {% endif %}
        </form>
    </div>

    {% if can_edit %}
    <!-- Tabs Container -->
    <div class="form-card" style="padding: 0; overflow: hidden;">
        <div class="profile-tabs" style="padding: 0 1rem; background: var(--surface);">
            <div class="profile-tab active" onclick="switchProfileTab('info')">
                <i class="material-icons">person</i> اطلاعات حساب
            </div>
            <div class="profile-tab" onclick="switchProfileTab('security')">
                <i class="material-icons">security</i> امنیت
            </div>
            <div class="profile-tab" onclick="switchProfileTab('danger')">
                <i class="material-icons">warning</i> خطرناک
            </div>
        </div>

        <!-- Tab: Info -->
        <div id="tab-info" class="tab-content active" style="padding: 2rem;">
            <form method="POST" action="{{ url_for('update_profile') }}">
                {{ update_profile_form.hidden_tag() }}
                <div class="form-group">
                    <label class="form-label">نام و نام خانوادگی</label>
                    {{ update_profile_form.full_name(class="form-control") }}
                </div>
                <div class="form-group">
                    <label class="form-label">رشته تحصیلی</label>
                    {{ update_profile_form.major(class="form-select") }}
                </div>
                <button type="submit" class="btn btn-custom">ذخیره تغییرات</button>
            </form>
        </div>

        <!-- Tab: Security -->
        <div id="tab-security" class="tab-content" style="padding: 2rem;">
            <form method="POST" action="{{ url_for('update_password') }}">
                {{ update_password_form.hidden_tag() }}
                <div class="form-group">
                    <label class="form-label">رمز عبور فعلی</label>
                    {{ update_password_form.current_password(class="form-control", type="password") }}
                </div>
                <div class="form-group">
                    <label class="form-label">رمز عبور جدید</label>
                    {{ update_password_form.new_password(class="form-control", type="password") }}
                </div>
                <div class="form-group">
                    <label class="form-label">تکرار رمز عبور جدید</label>
                    {{ update_password_form.confirm_new_password(class="form-control", type="password") }}
                </div>
                <button type="submit" class="btn btn-custom">تغییر رمز عبور</button>
            </form>
        </div>

        <!-- Tab: Danger -->
        <div id="tab-danger" class="tab-content" style="padding: 2rem;">
            <div style="background-color: rgba(183, 28, 28, 0.05); border: 1px solid var(--error); border-radius: 8px; padding: 1.5rem;">
                <h3 style="color: var(--error); margin-bottom: 0.5rem;">حذف حساب کاربری</h3>
                <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">
                    با حذف حساب کاربری، تمام اطلاعات شما شامل پیام‌ها و برنامه کلاسی به طور کامل پاک خواهد شد.
                </p>
                <form method="POST" action="{{ url_for('delete_account') }}" onsubmit="return confirm('آیا مطمئن هستید؟ این عملیات غیرقابل بازگشت است.');">
                    {{ delete_account_form.hidden_tag() }}
                    <button type="submit" class="btn" style="background-color: var(--error); color: white;">حذف حساب من</button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

</div>

<style>
    /* Profile Specific Styles */
    .profile-pic-wrapper { position: relative; width: 120px; height: 120px; margin: 0 auto 1.5rem; }
    .profile-pic-preview { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 4px solid var(--primary-light); }
    .profile-pic-edit { position: absolute; bottom: 0; right: 0; background-color: var(--primary-color); color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: var(--shadow-sm); transition: transform 0.2s; }
    .profile-pic-edit:hover { transform: scale(1.1); }

    .profile-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 0; }
    .profile-tab { padding: 1rem 1.5rem; cursor: pointer; font-weight: 500; color: var(--text-secondary); border-bottom: 2px solid transparent; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem; }
    .profile-tab:hover { color: var(--primary-color); background: var(--background); }
    .profile-tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
    
    .tab-content { display: none; animation: fadeIn 0.3s ease; }
    .tab-content.active { display: block; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>

{% endblock %}

{% block scripts %}
<script>
    function switchProfileTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.profile-tab').forEach(el => el.classList.remove('active'));
        
        document.getElementById('tab-' + tabName).classList.add('active');
        // Find the clicked tab and make it active
        event.target.closest('.profile-tab').classList.add('active');
    }
</script>
{% endblock %}