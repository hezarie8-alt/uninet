{% extends "base.html" %}

{% block title %}پروفایل کاربری | یونی نت{% endblock %}

{% block content %}
<div class="profile-container">
    <!-- Profile Header -->
    <div class="profile-header-card">
        <div class="profile-pic-wrapper">
            {% if user.profile_pic and user.profile_pic != 'default.jpg' %}
                <img src="{{ url_for('static', filename='uploads/profile_pics/' + user.profile_pic) }}" class="profile-pic" alt="Profile">
            {% else %}
                <img src="https://ui-avatars.com/api/?name={{ user.full_name }}&background=00838f&color=fff&size=200" class="profile-pic" alt="Avatar">
            {% endif %}
            
            {% if can_edit %}
            <label for="file-upload" class="edit-pic-btn">
                <i class="material-icons">camera_alt</i>
                <form id="pic-form" action="{{ url_for('update_profile') }}" method="POST" enctype="multipart/form-data" style="display:none;">
                    {{ forms.update_profile.hidden_tag() }}
                    <input id="file-upload" type="file" name="profile_pic" accept="image/*" onchange="document.getElementById('pic-form').submit();">
                </form>
            </label>
            {% endif %}
        </div>
        
        <div class="profile-info">
            <h1>{{ user.full_name }}</h1>
            <p><i class="material-icons">badge</i> شماره دانشجویی: {{ user.student_id }}</p>
            <p><i class="material-icons">school</i> رشته: {{ user.major }}</p>
        </div>

        {% if not can_edit %}
        <a href="{{ url_for('chat_main', user_id=user.id) }}" class="btn btn-primary" style="margin-top:1rem;">
            <i class="material-icons">chat</i> ارسال پیام
        </a>
        {% endif %}
    </div>

    {% if can_edit %}
    <!-- Settings Section -->
    <div class="settings-section">
        <div class="settings-tabs">
            <button class="settings-tab active" onclick="switchSettingsTab('info')">
                <i class="material-icons">person</i> ویرایش اطلاعات
            </button>
            <button class="settings-tab" onclick="switchSettingsTab('security')">
                <i class="material-icons">lock</i> امنیت
            </button>
            <button class="settings-tab" onclick="switchSettingsTab('danger')">
                <i class="material-icons">warning</i> خطرناک
            </button>
        </div>

        <div class="settings-content">
            <!-- Tab 1: Info -->
            <div id="tab-info" class="settings-panel active">
                <form action="{{ url_for('update_profile') }}" method="POST">
                    {{ forms.update_profile.hidden_tag() }}
                    <div class="form-group">
                        <label>نام و نام خانوادگی</label>
                        {{ forms.update_profile.full_name(class="form-input") }}
                    </div>
                    <div class="form-group">
                        <label>رشته تحصیلی</label>
                        {{ forms.update_profile.major(class="form-select") }}
                    </div>
                    <button type="submit" class="btn btn-primary">ذخیره تغییرات</button>
                </form>
            </div>

            <!-- Tab 2: Security -->
            <div id="tab-security" class="settings-panel">
                <form action="{{ url_for('update_password') }}" method="POST">
                    {{ forms.update_password.hidden_tag() }}
                    <div class="form-group">
                        <label>رمز عبور فعلی</label>
                        {{ forms.update_password.current_password(class="form-input", type="password") }}
                    </div>
                    <div class="form-group">
                        <label>رمز عبور جدید</label>
                        {{ forms.update_password.new_password(class="form-input", type="password") }}
                    </div>
                    <div class="form-group">
                        <label>تکرار رمز عبور جدید</label>
                        {{ forms.update_password.confirm_new_password(class="form-input", type="password") }}
                    </div>
                    <button type="submit" class="btn btn-primary">تغییر رمز عبور</button>
                </form>
            </div>

            <!-- Tab 3: Danger -->
            <div id="tab-danger" class="settings-panel">
                <div class="danger-zone">
                    <h3><i class="material-icons">error</i> حذف حساب کاربری</h3>
                    <p>با حذف حساب کاربری، تمام اطلاعات شما به طور کامل پاک خواهد شد و این عمل غیرقابل بازگشت است.</p>
                    <form action="{{ url_for('delete_account') }}" method="POST" onsubmit="return confirm('آیا اطمینان دارید؟ تمام اطلاعات شما پاک خواهد شد.');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-danger">حذف حساب من</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
    .profile-container { max-width: 800px; margin: 2rem auto; }
    
    .profile-header-card { 
        background: var(--surface); 
        padding: 2rem; 
        border-radius: var(--radius-lg); 
        box-shadow: var(--shadow-md); 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        text-align: center; 
        margin-bottom: 2rem; 
    }
    .profile-pic-wrapper { position: relative; width: 150px; height: 150px; margin-bottom: 1.5rem; }
    .profile-pic { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 4px solid var(--primary-light); }
    .edit-pic-btn { 
        position: absolute; bottom: 10px; right: 10px; 
        background: var(--primary-color); color: white; 
        width: 36px; height: 36px; border-radius: 50%; 
        display: flex; align-items: center; justify-content: center; 
        cursor: pointer; box-shadow: var(--shadow-md); transition: transform 0.2s;
    }
    .edit-pic-btn:hover { transform: scale(1.1); }
    
    .profile-info h1 { margin-bottom: 0.5rem; color: var(--text-primary); }
    .profile-info p { color: var(--text-secondary); margin-bottom: 0.25rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }

    .settings-section { background: var(--surface); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); overflow: hidden; }
    .settings-tabs { display: flex; border-bottom: 1px solid var(--border-color); background: var(--background); }
    .settings-tab { 
        flex: 1; padding: 1rem; background: none; border: none; 
        font-family: inherit; font-weight: 600; color: var(--text-secondary); 
        cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s;
        display: flex; align-items: center; justify-content: center; gap: 0.5rem;
    }
    .settings-tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); background: var(--surface); }
    
    .settings-content { padding: 2rem; }
    .settings-panel { display: none; animation: fadeIn 0.3s; }
    .settings-panel.active { display: block; }

    .danger-zone { border: 1px solid var(--error); border-radius: var(--radius-md); padding: 1.5rem; background: rgba(211, 47, 47, 0.05); }
    .danger-zone h3 { color: var(--error); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
    .danger-zone p { font-size: 0.9rem; margin-bottom: 1rem; color: var(--text-secondary); }

    @media (max-width: 600px) {
        .settings-tabs { flex-direction: column; }
        .settings-tab { justify-content: right; padding-right: 1.5rem; border-left: 3px solid transparent; border-bottom: 1px solid var(--border-color); }
        .settings-tab.active { border-left-color: var(--primary-color); border-bottom-color: transparent; }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    function switchSettingsTab(tabId) {
        // Update Tabs
        document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
        event.target.closest('.settings-tab').classList.add('active');
        
        // Update Panels
        document.querySelectorAll('.settings-panel').forEach(p => p.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
    }
</script>
{% endblock %}