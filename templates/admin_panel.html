{% extends "base.html" %}

{% block title %}پنل مدیریت | یونی نت{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1><i class="material-icons">admin_panel_settings</i> پنل مدیریت سیستم</h1>
        <p>تعریف کلاس‌های خالی و مدیریت درخواست‌های رزرو</p>
    </div>

    <div class="admin-grid">
        <!-- بخش اول: جدول ثبت کلاس خالی -->
        <div class="admin-section">
            <div class="section-title">جدول ثبت کلاس‌های خالی</div>
            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">
                روی هر سلول کلیک کنید تا کلاس خالی آن بازه زمانی را تعریف کنید.
            </p>
            
            <div class="schedule-grid" id="admin-schedule-grid">
                <!-- Header -->
                <div class="schedule-header"></div>
                <div class="schedule-header">شنبه</div>
                <div class="schedule-header">یکشنبه</div>
                <div class="schedule-header">دوشنبه</div>
                <div class="schedule-header">سه‌شنبه</div>
                <div class="schedule-header">چهارشنبه</div>

                <!-- Rows -->
                <div class="schedule-time">۸ - ۱۰</div>
                <div class="schedule-cell" data-day="saturday" data-time="8-10" onclick="openAddModal(this)"></div>
                <div class="schedule-cell" data-day="sunday" data-time="8-10" onclick="openAddModal(this)"></div>
                <div class="schedule-cell" data-day="monday" data-time="8-10" onclick="openAddModal(this)"></div>
                <div class="schedule-cell" data-day="tuesday" data-time="8-10" onclick="openAddModal(this)"></div>
                <div class="schedule-cell" data-day="wednesday" data-time="8-10" onclick="openAddModal(this)"></div>

                <div class="schedule-time">۱۰ - ۱۲</div>
                <div class="schedule-cell" data-day="saturday" data-time="10-12" onclick="openAddModal(this)"></div>
                <div class="schedule-cell" data-day="sunday" data-time="10-12" onclick="openAddModal(this)"></div>
                <div class="schedule-cell" data-day="monday" data-time="10-12" onclick="openAddModal(this)"></div>
                <div class="schedule-cell" data-day="tuesday" data-time="10-12" onclick="openAddModal(this)"></div>
                <div class="schedule-cell" data-day="wednesday" data-time="10-12" onclick="openAddModal(this)"></div>

                <div class="schedule-time">۱۲ - ۱۴</div>
                <div class="schedule-cell" data-day="saturday" data-time="12-14" onclick="openAddModal(this)"></div>
                <div class="schedule-cell" data-day="sunday" data-time="12-14" onclick="openAddModal(this)"></div>
                <div class="schedule-cell" data-day="monday" data-time="12-14" onclick="openAddModal(this)"></div>
                <div class="schedule-cell" data-day="tuesday" data-time="12-14" onclick="openAddModal(this)"></div>
                <div class="schedule-cell" data-day="wednesday" data-time="12-14" onclick="openAddModal(this)"></div>

                <div class="schedule-time">۱۴ - ۱۶</div>
                <div class="schedule-cell" data-day="saturday" data-time="14-16" onclick="openAddModal(this)"></div>
                <div class="schedule-cell" data-day="sunday" data-time="14-16" onclick="openAddModal(this)"></div>
                <div class="schedule-cell" data-day="monday" data-time="14-16" onclick="openAddModal(this)"></div>
                <div class="schedule-cell" data-day="tuesday" data-time="14-16" onclick="openAddModal(this)"></div>
                <div class="schedule-cell" data-day="wednesday" data-time="14-16" onclick="openAddModal(this)"></div>

                <div class="schedule-time">۱۶ - ۱۸</div>
                <div class="schedule-cell" data-day="saturday" data-time="16-18" onclick="openAddModal(this)"></div>
                <div class="schedule-cell" data-day="sunday" data-time="16-18" onclick="openAddModal(this)"></div>
                <div class="schedule-cell" data-day="monday" data-time="16-18" onclick="openAddModal(this)"></div>
                <div class="schedule-cell" data-day="tuesday" data-time="16-18" onclick="openAddModal(this)"></div>
                <div class="schedule-cell" data-day="wednesday" data-time="16-18" onclick="openAddModal(this)"></div>

                <div class="schedule-time">۱۸ - ۲۰</div>
                <div class="schedule-cell" data-day="saturday" data-time="18-20" onclick="openAddModal(this)"></div>
                <div class="schedule-cell" data-day="sunday" data-time="18-20" onclick="openAddModal(this)"></div>
                <div class="schedule-cell" data-day="monday" data-time="18-20" onclick="openAddModal(this)"></div>
                <div class="schedule-cell" data-day="tuesday" data-time="18-20" onclick="openAddModal(this)"></div>
                <div class="schedule-cell" data-day="wednesday" data-time="18-20" onclick="openAddModal(this)"></div>
            </div>
        </div>

        <!-- بخش دوم: لیست درخواست‌های رزرو -->
        <div class="admin-section">
            <div class="section-title">درخواست‌های در انتظار تایید ({{ requests|length }})</div>
            
            <div class="requests-list">
                {% if requests %}
                    {% for req in requests %}
                        <div class="request-card">
                            <div class="req-header">
                                <span class="req-user">{{ req.user.full_name }}</span>
                                <span class="req-time">{{ req.created_at.strftime('%m/%d') }}</span>
                            </div>
                            <div class="req-body">
                                <p><strong>زمان:</strong> {{ req.slot.day }} - {{ req.slot.time_slot }}</p>
                                <p><strong>مکان:</strong> {{ req.slot.location }}</p>
                                <p class="req-reason"><strong>دلیل:</strong> {{ req.reason }}</p>
                            </div>
                            <div class="req-actions">
                                <a href="{{ url_for('handle_reservation', req_id=req.id, action='approve') }}" class="btn btn-success btn-sm">
                                    تایید
                                </a>
                                <a href="{{ url_for('handle_reservation', req_id=req.id, action='reject') }}" class="btn btn-danger btn-sm">
                                    رد
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <i class="material-icons">check_circle</i>
                        <p>درخواستی در انتظار نیست.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal for Adding Slot -->
<div id="add-modal" class="modal-box">
    <div class="form-card" style="width: 400px; max-width: 90%;">
        <h3 style="margin-bottom: 1rem;">افزودن کلاس خالی</h3>
        <p id="modal-slot-info" style="color: var(--text-secondary); margin-bottom: 1rem;"></p>
        
        <form id="add-slot-form" method="POST" action="{{ url_for('admin_add_slot') }}">
            <input type="hidden" name="day" id="add-day">
            <input type="hidden" name="time_slot" id="add-time">
            
            <div class="form-group">
                <label class="form-label">محل برگزاری</label>
                <input type="text" name="location" class="form-control" placeholder="مثال: کلاس ۲۰۱" required>
            </div>
            
            <div style="display: flex; gap: 0.5rem;">
                <button type="submit" class="btn btn-custom" style="flex:1">ثبت کلاس خالی</button>
                <button type="button" class="btn btn-outline" onclick="closeModal()">لغو</button>
            </div>
        </form>
    </div>
</div>

<style>
    .admin-container { padding: 2rem 0; }
    .admin-header { text-align: center; margin-bottom: 2rem; }
    .admin-header h1 { font-size: 1.8rem; color: var(--primary-color); display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
    
    .admin-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; }
    @media (max-width: 992px) { .admin-grid { grid-template-columns: 1fr; } }
    
    .admin-section { background: var(--surface); border-radius: 12px; padding: 1.5rem; box-shadow: var(--shadow-md); }
    .section-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem; border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem; }

    .schedule-cell { position: relative; background: var(--surface); }
    .schedule-cell.has-slot { background-color: rgba(5, 150, 105, 0.1); border-right: 3px solid var(--success); }
    .slot-badge { font-size: 0.75rem; background: var(--success); color: white; padding: 0.1rem 0.3rem; border-radius: 4px; display: inline-block; margin-top: 0.25rem; }

    .request-card { border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem; overflow: hidden; }
    .req-header { background: var(--background); padding: 0.75rem; display: flex; justify-content: space-between; font-size: 0.9rem; }
    .req-user { font-weight: 600; color: var(--primary-color); }
    .req-body { padding: 0.75rem; font-size: 0.9rem; }
    .req-reason { margin-top: 0.5rem; font-style: italic; color: var(--text-secondary); }
    .req-actions { padding: 0.75rem; display: flex; gap: 0.5rem; border-top: 1px solid var(--border-color); }

    .btn-sm { padding: 0.4rem 1rem; font-size: 0.85rem; }
    .btn-success { background-color: var(--success); color: white; }
    .btn-danger { background-color: var(--error); color: white; }
    .empty-state { text-align: center; padding: 2rem; color: var(--text-secondary); }
    .modal-box { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
</style>
{% endblock %}

{% block scripts %}
<script>
    const dayMap = {'saturday':'شنبه','sunday':'یکشنبه','monday':'دوشنبه','tuesday':'سه‌شنبه','wednesday':'چهارشنبه'};
    const slots = {{ slots | tojson }};
    
    // نمایش کلاس‌های خالی موجود در جدول
    document.addEventListener('DOMContentLoaded', () => {
        slots.forEach(slot => {
            const cell = document.querySelector(`.schedule-cell[data-day="${slot.day}"][data-time="${slot.time_slot}"]`);
            if (cell) {
                cell.classList.add('has-slot');
                cell.innerHTML = `<div style="font-size:0.8rem; font-weight:bold;">${slot.location}</div><span class="slot-badge">خالی</span>`;
                // تغییر کلیک به حذف (اختیاری: می‌توان لینک حذف گذاشت)
                cell.onclick = () => { if(confirm('این کلاس حذف شود؟')) window.location.href = `/admin/delete_slot/${slot.id}`; };
            }
        });
    });

    function openAddModal(cell) {
        // اگر قبلاً خالی تعریف شده، کاری نکن (چون onclick تغییر کرده)
        if(cell.classList.contains('has-slot')) return;

        document.getElementById('add-day').value = cell.dataset.day;
        document.getElementById('add-time').value = cell.dataset.time;
        document.getElementById('modal-slot-info').innerText = `بازه: ${dayMap[cell.dataset.day]} - ساعت ${cell.dataset.time}`;
        document.getElementById('add-modal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('add-modal').style.display = 'none';
    }
</script>
{% endblock %}