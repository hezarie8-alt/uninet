{% extends "base.html" %}

{% block title %}Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ | ÛŒÙˆÙ†ÛŒ Ù†Øª{% endblock %}

{% block content %}
<div class="dashboard-container">

    <div class="dashboard-top-row">
        <div class="datetime-widget">
            <div class="datetime-inner">
                <div class="datetime-top">
                    <div class="datetime-icon-area">
                        <i class="material-icons datetime-main-icon">today</i>
                    </div>
                    <div class="datetime-details">
                        <div class="datetime-weekday" id="dt-weekday">{{ weekday_name }}</div>
                        <div class="datetime-date" id="dt-date">
                            {% if today_j %}
                                {{ today_j.strftime('%d %B %Y') }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="datetime-divider"></div>
                <div class="datetime-clock-row">
                    <i class="material-icons" style="font-size:1.1rem; opacity:.7;">schedule</i>
                    <span class="datetime-clock" id="live-clock">--:--:--</span>
                </div>
            </div>
        </div>
        <div class="notifications-widget">
            <div class="widget-header">
                <i class="material-icons">notifications_active</i>
                <span>Ø§Ø·Ù„Ø§Ø¹ÛŒÙ‡â€ŒÙ‡Ø§</span>
                {% if notifications %}
                    <span class="notif-count-badge">{{ notifications|length }}</span>
                {% endif %}
            </div>
            {% if notifications %}
                <ul class="notif-list">
                    {% for notif in notifications %}
                        <li class="notif-item {% if not notif.is_read %}unread{% endif %}"
                            onclick="markRead({{ notif.id }}, this)">
                            <i class="material-icons notif-icon">info_outline</i>
                            <div class="notif-body">
                                <span class="notif-text">{{ notif.message }}</span>
                                <small class="notif-time">{{ notif.created_at.strftime('%H:%M') }}</small>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <div class="empty-notif">
                    <i class="material-icons">check_circle_outline</i>
                    <span>Ø§Ø·Ù„Ø§Ø¹ÛŒÙ‡ Ø¬Ø¯ÛŒØ¯ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</span>
                </div>
            {% endif %}
        </div>
    </div>
    {% if cancelled_classes %}
    <div class="cancelled-alert-banner">
        <div class="alert-icon"><i class="material-icons">warning_amber</i></div>
        <div class="alert-content">
            <strong>Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ Ù„ØºÙˆ Ø´Ø¯Ù‡ Ø§Ù…Ø±ÙˆØ²:</strong>
            {% for c in cancelled_classes %}
                <span class="alert-item">
                    {{ c.course_name }} (Ø§Ø³ØªØ§Ø¯ {{ c.professor_name }})
                    {% if c.description %} â€” {{ c.description }}{% endif %}
                </span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    <div class="tabs-bar">
        <button class="dash-tab active" id="tab-btn-schedule" onclick="openTab('personal-schedule', this)">
            <i class="material-icons">event_note</i>
            <span>Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ Ù…Ù†</span>
        </button>
        <button class="dash-tab" id="tab-btn-reserve" onclick="openTab('reserve-room', this)">
            <i class="material-icons">meeting_room</i>
            <span>Ø±Ø²Ø±Ùˆ Ú©Ù„Ø§Ø³</span>
        </button>
        <button class="dash-tab" id="tab-btn-cancelled" onclick="openTab('cancelled-classes', this)">
            <i class="material-icons">event_busy</i>
            <span>Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ Ù„ØºÙˆ Ø´Ø¯Ù‡</span>
            {% if all_cancelled_classes %}
                <span class="tab-badge">{{ all_cancelled_classes|length }}</span>
            {% endif %}
        </button>
    </div>
    <div id="personal-schedule" class="tab-content active">
        <div class="section-card">
            <div class="section-card-header">
                <div class="section-card-title">
                    <i class="material-icons">event_note</i>
                    <h2>Ø¨Ø±Ù†Ø§Ù…Ù‡ Ú©Ù„Ø§Ø³ÛŒ Ø´Ø®ØµÛŒ</h2>
                </div>
                <div class="section-card-actions">
                    <button class="btn btn-outline" onclick="openPasteModal()" title="ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§Ø² Ø§Ú©Ø³Ù„">
                        <i class="material-icons">table_view</i>
                        <span>ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ø§Ø² Ø§Ú©Ø³Ù„</span>
                    </button>
                    <button class="btn btn-outline" onclick="copyScheduleAsText()" title="Ú©Ù¾ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ">
                        <i class="material-icons">content_copy</i>
                        <span>Ú©Ù¾ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡</span>
                    </button>
                    <button class="btn btn-outline" onclick="printSchedule()" title="Ú†Ø§Ù¾">
                        <i class="material-icons">print</i>
                        <span>Ú†Ø§Ù¾</span>
                    </button>
                </div>
            </div>
            <p class="section-hint">
                <i class="material-icons" style="font-size:1rem; vertical-align:middle;">touch_app</i>
                Ø±ÙˆÛŒ Ù‡Ø± Ø®Ø§Ù†Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ Ú©Ù„Ø§Ø³ Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ ÛŒØ§ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†ÛŒØ¯.
            </p>
            <div class="schedule-wrapper">
                <div class="schedule-grid" id="schedule-table">
                    <div class="schedule-header corner-cell"></div>
                    <div class="schedule-header">Ø´Ù†Ø¨Ù‡</div>
                    <div class="schedule-header">ÛŒÚ©Ø´Ù†Ø¨Ù‡</div>
                    <div class="schedule-header">Ø¯ÙˆØ´Ù†Ø¨Ù‡</div>
                    <div class="schedule-header">Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡</div>
                    <div class="schedule-header">Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡</div>

                    {% set times = ['8-10', '10-12', '12-14', '14-16', '16-18', '18-20'] %}
                    {% set time_labels = ['Û¸ - Û±Û°', 'Û±Û° - Û±Û²', 'Û±Û² - Û±Û´', 'Û±Û´ - Û±Û¶', 'Û±Û¶ - Û±Û¸', 'Û±Û¸ - Û²Û°'] %}

                    {% for i in range(6) %}
                        <div class="schedule-time">{{ time_labels[i] }}</div>
                        {% for day in ['saturday', 'sunday', 'monday', 'tuesday', 'wednesday'] %}
                            <div class="schedule-cell clickable-cell"
                                 data-day="{{ day }}"
                                 data-time="{{ times[i] }}"
                                 onclick="openEditModal(this)">
                            </div>
                        {% endfor %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div id="reserve-room" class="tab-content">
        <div class="section-card">
            <div class="section-card-header">
                <div class="section-card-title">
                    <i class="material-icons">meeting_room</i>
                    <h2>ÙˆØ¶Ø¹ÛŒØª Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ Ø®Ø§Ù„ÛŒ</h2>
                </div>
                <button class="btn btn-outline" onclick="loadAvailableSlots()">
                    <i class="material-icons">refresh</i>
                    <span>Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</span>
                </button>
            </div>

            <p class="section-hint">
                <i class="material-icons" style="font-size:1rem; vertical-align:middle;">info_outline</i>
                Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ Ø±Ù†Ú¯ÛŒ Ù‚Ø§Ø¨Ù„ Ø±Ø²Ø±Ùˆ Ù‡Ø³ØªÙ†Ø¯. Ø±ÙˆÛŒ Ù‡Ø± Ú©Ù„Ø§Ø³ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø²Ø±Ùˆ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.
            </p>

            <div class="schedule-wrapper">
                <div class="schedule-grid" id="reservation-table">
                    <div class="schedule-header corner-cell"></div>
                    <div class="schedule-header">Ø´Ù†Ø¨Ù‡</div>
                    <div class="schedule-header">ÛŒÚ©Ø´Ù†Ø¨Ù‡</div>
                    <div class="schedule-header">Ø¯ÙˆØ´Ù†Ø¨Ù‡</div>
                    <div class="schedule-header">Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡</div>
                    <div class="schedule-header">Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡</div>

                    {% for i in range(6) %}
                        <div class="schedule-time">{{ time_labels[i] }}</div>
                        {% for day in ['saturday', 'sunday', 'monday', 'tuesday', 'wednesday'] %}
                            <div class="schedule-cell reserve-cell"
                                 data-day="{{ day }}"
                                 data-time="{{ times[i] }}">
                                <span class="cell-loading">...</span>
                            </div>
                        {% endfor %}
                    {% endfor %}
                </div>
            </div>

            <div class="legend-row">
                <div class="legend-item">
                    <span class="legend-dot available"></span>
                    <span>Ú©Ù„Ø§Ø³ Ø®Ø§Ù„ÛŒ (Ù‚Ø§Ø¨Ù„ Ø±Ø²Ø±Ùˆ)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-dot reserved"></span>
                    <span>Ø±Ø²Ø±Ùˆ Ø´Ø¯Ù‡</span>
                </div>
                <div class="legend-item">
                    <span class="legend-dot empty-slot"></span>
                    <span>ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡</span>
                </div>
            </div>
        </div>
    </div>
    <div id="cancelled-classes" class="tab-content">
        <div class="section-card">
            <div class="section-card-header">
                <div class="section-card-title">
                    <i class="material-icons">event_busy</i>
                    <h2>Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ Ù„ØºÙˆ Ø´Ø¯Ù‡</h2>
                </div>
            </div>

            {% if all_cancelled_classes %}
                <div class="cancelled-grid">
                    {% for c in all_cancelled_classes %}
                        <div class="cancelled-card">
                            <div class="cancelled-card-header">
                                <div class="cancelled-course-info">
                                    <span class="cancelled-course-name">{{ c.course_name or 'Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…' }}</span>
                                    <span class="cancelled-professor">
                                        <i class="material-icons" style="font-size:.9rem;">person</i>
                                        Ø§Ø³ØªØ§Ø¯ {{ c.professor_name or 'Ù†Ø§Ù…Ø´Ø®Øµ' }}
                                    </span>
                                </div>
                                <div class="cancelled-date-badge">
                                    {% if c.cancel_date %}
                                        <i class="material-icons">event</i>
                                        {{ c.cancel_date.strftime('%Y/%m/%d') }}
                                    {% elif c.start_date %}
                                        <i class="material-icons">date_range</i>
                                        {{ c.start_date.strftime('%Y/%m/%d') }} ØªØ§ {{ c.end_date.strftime('%Y/%m/%d') if c.end_date else '?' }}
                                    {% else %}
                                        <i class="material-icons">all_inclusive</i>
                                        Ù†Ø§Ù…Ø´Ø®Øµ
                                    {% endif %}
                                </div>
                            </div>
                            {% if c.description %}
                                <div class="cancelled-desc">
                                    <i class="material-icons" style="font-size:.9rem;">notes</i>
                                    {{ c.description }}
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state-full">
                    <i class="material-icons">event_available</i>
                    <h3>Ù‡ÛŒÚ† Ú©Ù„Ø§Ø³ÛŒ Ù„ØºÙˆ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</h3>
                    <p>Ø¯Ø± ØµÙˆØ±Øª Ù„ØºÙˆ Ù‡Ø± Ú©Ù„Ø§Ø³ÛŒ ØªÙˆØ³Ø· Ù…Ø¯ÛŒØ±ÛŒØªØŒ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>
                </div>
            {% endif %}
        </div>
    </div>

</div><!-- /dashboard-container -->

<div id="edit-modal" class="modal-overlay" onclick="handleOverlayClick(event, 'edit-modal')">
    <div class="modal-card" onclick="event.stopPropagation()">
        <div class="modal-card-header">
            <h3 id="modal-title">Ø§ÙØ²ÙˆØ¯Ù† Ú©Ù„Ø§Ø³</h3>
            <button class="modal-close-btn" onclick="closeModal('edit-modal')">
                <i class="material-icons">close</i>
            </button>
        </div>

        <form id="schedule-form" onsubmit="handleScheduleSubmit(event)">
            <input type="hidden" id="day-input">
            <input type="hidden" id="time-input">

            <div class="form-group">
                <label class="form-label">
                    <i class="material-icons form-label-icon">menu_book</i>
                    Ù†Ø§Ù… Ø¯Ø±Ø³
                </label>
                <input type="text" id="course-name" class="form-control"
                       placeholder="Ù…Ø«Ø§Ù„: Ø±ÛŒØ§Ø¶ÛŒ Ù…Ù‡Ù†Ø¯Ø³ÛŒ" autocomplete="off">
            </div>

            <div class="form-group">
                <label class="form-label">
                    <i class="material-icons form-label-icon">person</i>
                    Ù†Ø§Ù… Ø§Ø³ØªØ§Ø¯
                </label>
                <input type="text" id="professor-name" class="form-control"
                       placeholder="Ù…Ø«Ø§Ù„: Ø¯Ú©ØªØ± Ù…Ø­Ù…Ø¯ÛŒ" autocomplete="off">
            </div>

            <div class="form-group">
                <label class="form-label">
                    <i class="material-icons form-label-icon">location_on</i>
                    Ù…Ø­Ù„ Ø¨Ø±Ú¯Ø²Ø§Ø±ÛŒ
                </label>
                <input type="text" id="class-location" class="form-control"
                       placeholder="Ù…Ø«Ø§Ù„: Ú©Ù„Ø§Ø³ Û±Û°Û±" autocomplete="off">
            </div>

            <div class="form-group">
                <label class="form-label">
                    <i class="material-icons form-label-icon">repeat</i>
                    Ù†ÙˆØ¹ Ù‡ÙØªÙ‡
                </label>
                <div class="week-type-selector">
                    <label class="week-type-option">
                        <input type="radio" name="week_type" value="all" checked>
                        <span class="week-type-label all">Ù‡Ø± Ù‡ÙØªÙ‡</span>
                    </label>
                    <label class="week-type-option">
                        <input type="radio" name="week_type" value="odd">
                        <span class="week-type-label odd">Ù‡ÙØªÙ‡ ÙØ±Ø¯</span>
                    </label>
                    <label class="week-type-option">
                        <input type="radio" name="week_type" value="even">
                        <span class="week-type-label even">Ù‡ÙØªÙ‡ Ø²ÙˆØ¬</span>
                    </label>
                </div>
            </div>

            <div class="modal-actions">
                <button type="submit" class="btn btn-custom">
                    <i class="material-icons">save</i> Ø°Ø®ÛŒØ±Ù‡
                </button>
                <button type="button" class="btn btn-danger-outline" onclick="deleteClass()">
                    <i class="material-icons">delete_outline</i> Ø­Ø°Ù
                </button>
                <button type="button" class="btn btn-outline" onclick="closeModal('edit-modal')">
                    Ø§Ù†ØµØ±Ø§Ù
                </button>
            </div>
        </form>
    </div>
</div>

<div id="reserve-modal" class="modal-overlay" onclick="handleOverlayClick(event, 'reserve-modal')">
    <div class="modal-card" onclick="event.stopPropagation()">
        <div class="modal-card-header">
            <h3>Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø²Ø±Ùˆ Ú©Ù„Ø§Ø³</h3>
            <button class="modal-close-btn" onclick="closeModal('reserve-modal')">
                <i class="material-icons">close</i>
            </button>
        </div>

        <div class="reserve-slot-info-card" id="reserve-slot-info-card">
            <div class="slot-info-row">
                <i class="material-icons">meeting_room</i>
                <span id="reserve-room-display">â€”</span>
            </div>
            <div class="slot-info-row">
                <i class="material-icons">access_time</i>
                <span id="reserve-time-display">â€”</span>
            </div>
        </div>

        <form id="reserve-form" method="POST" action="">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="form-group">
                <label class="form-label">
                    <i class="material-icons form-label-icon">description</i>
                    Ø¯Ù„ÛŒÙ„ Ø±Ø²Ø±Ùˆ
                </label>
                <textarea id="reserve-reason" name="reason" class="form-control"
                          rows="3" required
                          placeholder="Ù…Ø«Ø§Ù„: Ø¬Ù„Ø³Ù‡ Ø§Ù†Ø¬Ù…Ù† Ø¹Ù„Ù…ÛŒØŒ Ú©Ù„Ø§Ø³ Ø¬Ø¨Ø±Ø§Ù†ÛŒ..."></textarea>
            </div>

            <div class="modal-actions">
                <button type="submit" class="btn btn-custom">
                    <i class="material-icons">send</i> Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª
                </button>
                <button type="button" class="btn btn-outline" onclick="closeModal('reserve-modal')">
                    Ø§Ù†ØµØ±Ø§Ù
                </button>
            </div>
        </form>
    </div>
</div>

<div id="paste-modal" class="modal-overlay" onclick="handleOverlayClick(event, 'paste-modal')">
    <div class="modal-card modal-wide" onclick="event.stopPropagation()">
        <div class="modal-card-header">
            <h3>ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§Ø² Ø§Ú©Ø³Ù„</h3>
            <button class="modal-close-btn" onclick="closeModal('paste-modal')">
                <i class="material-icons">close</i>
            </button>
        </div>
        <div class="excel-guide">
            <p class="guide-title"><i class="material-icons">help_outline</i> Ø±Ø§Ù‡Ù†Ù…Ø§:</p>
            <p>Ø¬Ø¯ÙˆÙ„ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Excel Ø§Ù†ØªØ®Ø§Ø¨ Ùˆ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯ (Ctrl+C)ØŒ Ø³Ù¾Ø³ Ø¯Ø± Ú©Ø§Ø¯Ø± Ø²ÛŒØ± Ù¾ÛŒØ³Øª Ú©Ù†ÛŒØ¯ (Ctrl+V).</p>
            <p>Ø³ÛŒØ³ØªÙ… Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ù†Ø§Ù… Ø¯Ø±Ø³ØŒ Ø§Ø³ØªØ§Ø¯ØŒ Ù…Ø­Ù„ Ùˆ Ù†ÙˆØ¹ Ù‡ÙØªÙ‡ (Ø²ÙˆØ¬/ÙØ±Ø¯) Ø±Ø§ ØªØ´Ø®ÛŒØµ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.</p>
            <p class="guide-hint">ÙØ±Ù…Øª Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ Ù‡Ø± Ø®Ø§Ù†Ù‡: <code>Ù†Ø§Ù… Ø¯Ø±Ø³ | Ø§Ø³ØªØ§Ø¯ | Ù…Ø­Ù„ | Ø²ÙˆØ¬/ÙØ±Ø¯</code></p>
        </div>

        <div class="form-group">
            <label class="form-label">Ù…Ø­ØªÙˆØ§ÛŒ Ú©Ù¾ÛŒâ€ŒØ´Ø¯Ù‡ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù¾ÛŒØ³Øª Ú©Ù†ÛŒØ¯:</label>
            <textarea id="excel-paste-area" class="form-control excel-paste-area"
                      rows="8"
                      placeholder="Ctrl+V Ø¨Ø²Ù†ÛŒØ¯..."
                      onpaste="setTimeout(() => parseExcelPaste(), 100)"
                      oninput="parseExcelPaste()"></textarea>
        </div>
        <div id="paste-preview" class="paste-preview" style="display:none;">
            <h4><i class="material-icons">preview</i> Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ({{ "{}" }} Ø±Ø¯ÛŒÙ ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯)</h4>
            <div id="paste-preview-table"></div>
        </div>

        <div class="modal-actions">
            <button class="btn btn-custom" onclick="applyPastedSchedule()" id="apply-paste-btn" disabled>
                <i class="material-icons">check</i> Ø§Ø¹Ù…Ø§Ù„ Ø¨Ø±Ù†Ø§Ù…Ù‡
            </button>
            <button class="btn btn-outline" onclick="closeModal('paste-modal')">Ø§Ù†ØµØ±Ø§Ù</button>
        </div>
    </div>
</div>

<style>
.dashboard-container {
    padding: 1.5rem 1rem;
    max-width: 1200px;
    margin: 0 auto;
}

.dashboard-top-row {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 1.25rem;
    margin-bottom: 1.5rem;
}
@media (max-width: 768px) {
    .dashboard-top-row { grid-template-columns: 1fr; }
}
.datetime-widget {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
    border-radius: 16px;
    padding: 1.5rem;
    color: white;
    box-shadow: 0 8px 24px rgba(0,131,143,0.3);
}
.datetime-inner { display: flex; flex-direction: column; gap: .75rem; }
.datetime-top { display: flex; align-items: center; gap: 1rem; }
.datetime-icon-area {
    width: 54px; height: 54px;
    background: rgba(255,255,255,.2);
    border-radius: 14px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
}
.datetime-main-icon { font-size: 2rem; }
.datetime-weekday { font-size: 1.6rem; font-weight: 700; line-height: 1; }
.datetime-date { font-size: .9rem; opacity: .85; margin-top: .25rem; }
.datetime-divider {
    height: 1px;
    background: rgba(255,255,255,.25);
    margin: .25rem 0;
}
.datetime-clock-row {
    display: flex; align-items: center; gap: .5rem;
    opacity: .9;
}
.datetime-clock {
    font-size: 1.8rem;
    font-weight: 300;
    font-family: 'Courier New', monospace;
    letter-spacing: 2px;
}
.notifications-widget {
    background: var(--surface);
    border-radius: 16px;
    padding: 1.25rem;
    box-shadow: var(--shadow-sm);
    display: flex; flex-direction: column; gap: .75rem;
    border: 1px solid var(--border-color);
}
.widget-header {
    display: flex; align-items: center; gap: .5rem;
    font-weight: 600; font-size: 1rem; color: var(--primary-color);
}
.notif-count-badge {
    background: var(--primary-color); color: white;
    border-radius: 20px; padding: .1rem .55rem;
    font-size: .75rem; font-weight: 700;
}
.notif-list { list-style: none; overflow-y: auto; max-height: 130px; }
.notif-item {
    display: flex; align-items: flex-start; gap: .5rem;
    padding: .5rem .6rem; border-radius: 8px;
    cursor: pointer; transition: background .2s;
    margin-bottom: .3rem;
}
.notif-item:hover { background: var(--background); }
.notif-item.unread {
    background: rgba(0,131,143,.08);
    border-right: 3px solid var(--primary-color);
}
.notif-icon { font-size: 1.1rem; color: var(--primary-color); flex-shrink: 0; margin-top: 2px; }
.notif-body { display: flex; flex-direction: column; gap: .1rem; }
.notif-text { font-size: .88rem; }
.notif-time { font-size: .75rem; color: var(--text-secondary); }
.empty-notif {
    display: flex; align-items: center; gap: .5rem;
    color: var(--text-secondary); font-size: .9rem;
    padding: .5rem;
}
.empty-notif i { color: var(--success); }
.cancelled-alert-banner {
    display: flex; align-items: flex-start; gap: 1rem;
    background: rgba(183,28,28,.07);
    border: 1px solid rgba(183,28,28,.3);
    border-right: 4px solid var(--error);
    border-radius: 10px; padding: 1rem 1.25rem;
    margin-bottom: 1.5rem;
}
.alert-icon { color: var(--error); flex-shrink: 0; margin-top: 2px; }
.alert-content { font-size: .9rem; display: flex; flex-direction: column; gap: .3rem; }
.alert-item { color: var(--error); }
.tabs-bar {
    display: flex; gap: .5rem;
    background: var(--surface);
    border: 1px solid var(--border-color);
    border-radius: 14px; padding: .5rem;
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow-sm);
}
.dash-tab {
    flex: 1; display: flex; align-items: center; justify-content: center; gap: .4rem;
    padding: .75rem 1rem;
    border: none; background: transparent;
    border-radius: 10px; cursor: pointer;
    font-family: inherit; font-size: .9rem; font-weight: 500;
    color: var(--text-secondary); transition: all .25s;
    position: relative;
}
.dash-tab:hover { background: var(--background); color: var(--primary-color); }
.dash-tab.active {
    background: var(--primary-color);
    color: white;
    box-shadow: 0 4px 12px rgba(0,131,143,.3);
}
.tab-badge {
    background: rgba(255,255,255,.3); color: white;
    border-radius: 20px; padding: .05rem .45rem;
    font-size: .72rem; font-weight: 700;
}
.dash-tab:not(.active) .tab-badge {
    background: var(--primary-color); color: white;
}
@media (max-width: 600px) {
    .dash-tab span { display: none; }
    .dash-tab { padding: .75rem; }
}
.tab-content { display: none; animation: fadeIn .3s ease; }
.tab-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

.section-card {
    background: var(--surface);
    border-radius: 16px; padding: 1.5rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
}
.section-card-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 1rem; flex-wrap: wrap; gap: .75rem;
}
.section-card-title {
    display: flex; align-items: center; gap: .5rem;
    color: var(--primary-color);
}
.section-card-title h2 { font-size: 1.15rem; font-weight: 700; margin: 0; }
.section-card-title i { font-size: 1.4rem; }
.section-card-actions { display: flex; gap: .5rem; flex-wrap: wrap; }
.section-hint {
    font-size: .85rem; color: var(--text-secondary);
    background: var(--background); border-radius: 8px;
    padding: .5rem .85rem; margin-bottom: 1.25rem;
}
.schedule-wrapper { overflow-x: auto; }
.schedule-grid {
    display: grid;
    grid-template-columns: 70px repeat(5, 1fr);
    gap: 1px;
    background: var(--border-color);
    border: 1px solid var(--border-color);
    border-radius: 10px; overflow: hidden;
    min-width: 560px;
}
.schedule-header {
    background: var(--background);
    padding: .75rem .5rem; text-align: center;
    font-weight: 700; font-size: .85rem; color: var(--text-secondary);
}
.corner-cell { background: var(--background); }
.schedule-time {
    background: var(--background);
    padding: .75rem .25rem; text-align: center;
    font-size: .8rem; font-weight: 600; color: var(--text-secondary);
    display: flex; align-items: center; justify-content: center;
}
.schedule-cell {
    background: var(--surface);
    min-height: 80px; padding: .4rem;
    position: relative; vertical-align: top;
}
.clickable-cell {
    cursor: pointer; transition: background .18s;
}
.clickable-cell:hover {
    background: rgba(0,131,143,.05);
}
.clickable-cell:hover::after {
    content: '+';
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 1.8rem; color: var(--primary-color);
    opacity: .3; font-weight: 300;
    pointer-events: none;
}
.clickable-cell.has-class:hover::after { display: none; }
.cell-class-all {
    background: rgba(0,131,143,.1);
    border-right: 3px solid var(--primary-color);
    border-radius: 6px; padding: .4rem .5rem;
    height: 100%; min-height: 70px;
    display: flex; flex-direction: column; justify-content: center;
}
.cell-class-split { display: flex; flex-direction: column; height: 100%; gap: 1px; }
.cell-half {
    flex: 1; border-radius: 5px; padding: .3rem .4rem;
    display: flex; flex-direction: column; justify-content: center;
    min-height: 34px;
}
.cell-half.bg-odd { background: rgba(33,150,243,.13); border-right: 3px solid #2196f3; }
.cell-half.bg-even { background: rgba(76,175,80,.13); border-right: 3px solid #4caf50; }
.cell-name { font-size: .82rem; font-weight: 700; color: var(--primary-color); margin-bottom: 2px; }
.cell-info { font-size: .72rem; color: var(--text-secondary); line-height: 1.3; }
.cell-week-tag {
    font-size: .65rem; padding: .1rem .35rem;
    border-radius: 20px; display: inline-block; margin-top: 2px;
}
.week-tag-odd { background: rgba(33,150,243,.15); color: #1565c0; }
.week-tag-even { background: rgba(76,175,80,.15); color: #1b5e20; }
.week-tag-all { background: rgba(0,131,143,.15); color: var(--primary-dark); }
.reserve-cell { cursor: default; padding: .35rem; }
.cell-loading { font-size: .75rem; color: var(--text-secondary); opacity: .5; }
.room-pill {
    display: inline-block;
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    color: white; padding: .2rem .55rem;
    border-radius: 20px; font-size: .75rem;
    margin: 2px; cursor: pointer;
    transition: transform .15s, box-shadow .15s;
    border: none; font-family: inherit;
}
.room-pill:hover {
    transform: scale(1.07);
    box-shadow: 0 3px 8px rgba(0,131,143,.35);
}
.cell-reserved-text {
    font-size: .75rem; color: var(--error);
    opacity: .7; text-align: center;
    display: block; padding-top: .5rem;
}
.cell-empty-text {
    font-size: .75rem; color: var(--text-secondary);
    opacity: .4; text-align: center;
    display: block; padding-top: .5rem;
}
.legend-row {
    display: flex; gap: 1.5rem; margin-top: 1rem;
    flex-wrap: wrap;
}
.legend-item { display: flex; align-items: center; gap: .4rem; font-size: .82rem; color: var(--text-secondary); }
.legend-dot {
    width: 12px; height: 12px; border-radius: 50%;
}
.legend-dot.available { background: var(--primary-color); }
.legend-dot.reserved { background: var(--error); }
.legend-dot.empty-slot { background: var(--border-color); }
.cancelled-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem; margin-top: .5rem;
}
.cancelled-card {
    border: 1px solid var(--border-color);
    border-right: 4px solid var(--error);
    border-radius: 10px; padding: 1rem;
    background: rgba(183,28,28,.03);
    transition: box-shadow .2s;
}
.cancelled-card:hover { box-shadow: var(--shadow-md); }
.cancelled-card-header {
    display: flex; justify-content: space-between; align-items: flex-start;
    gap: .75rem; margin-bottom: .5rem;
}
.cancelled-course-info { display: flex; flex-direction: column; gap: .25rem; }
.cancelled-course-name { font-weight: 700; font-size: 1rem; }
.cancelled-professor {
    display: flex; align-items: center; gap: .25rem;
    font-size: .85rem; color: var(--text-secondary);
}
.cancelled-date-badge {
    display: flex; align-items: center; gap: .3rem;
    font-size: .8rem; color: var(--error);
    background: rgba(183,28,28,.08);
    padding: .25rem .65rem; border-radius: 20px;
    white-space: nowrap; flex-shrink: 0;
}
.cancelled-desc {
    display: flex; align-items: center; gap: .3rem;
    font-size: .83rem; color: var(--text-secondary);
    border-top: 1px dashed var(--border-color);
    padding-top: .5rem; margin-top: .5rem;
}
.empty-state-full {
    text-align: center; padding: 3rem 1rem;
    color: var(--text-secondary);
}
.empty-state-full i { font-size: 3.5rem; color: var(--success); margin-bottom: .75rem; display: block; }
.empty-state-full h3 { margin-bottom: .5rem; color: var(--text-primary); }
.modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,.4); backdrop-filter: blur(3px);
    z-index: 2000;
    align-items: center; justify-content: center;
    padding: 1rem;
}
.modal-overlay.open { display: flex; animation: fadeIn .2s ease; }
.modal-card {
    background: var(--surface);
    border-radius: 16px; padding: 1.5rem;
    width: 100%; max-width: 440px;
    box-shadow: 0 20px 60px rgba(0,0,0,.2);
    max-height: 90vh; overflow-y: auto;
}
.modal-wide { max-width: 600px; }
.modal-card-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 1.25rem;
}
.modal-card-header h3 { font-size: 1.15rem; color: var(--text-primary); }
.modal-close-btn {
    background: none; border: none; cursor: pointer;
    color: var(--text-secondary); padding: .25rem;
    border-radius: 50%; display: flex; align-items: center;
    transition: background .2s;
}
.modal-close-btn:hover { background: var(--background); color: var(--text-primary); }
.week-type-selector {
    display: flex; gap: .5rem; flex-wrap: wrap;
}
.week-type-option { cursor: pointer; }
.week-type-option input[type="radio"] { display: none; }
.week-type-label {
    display: block; padding: .5rem 1rem;
    border-radius: 8px; border: 2px solid var(--border-color);
    font-size: .9rem; transition: all .2s; cursor: pointer;
}
.week-type-option input:checked + .week-type-label.all {
    border-color: var(--primary-color);
    background: rgba(0,131,143,.1);
    color: var(--primary-color); font-weight: 700;
}
.week-type-option input:checked + .week-type-label.odd {
    border-color: #2196f3;
    background: rgba(33,150,243,.1);
    color: #1565c0; font-weight: 700;
}
.week-type-option input:checked + .week-type-label.even {
    border-color: #4caf50;
    background: rgba(76,175,80,.1);
    color: #1b5e20; font-weight: 700;
}

.reserve-slot-info-card {
    background: rgba(0,131,143,.07);
    border: 1px solid rgba(0,131,143,.2);
    border-radius: 10px; padding: .85rem 1rem;
    margin-bottom: 1.25rem;
    display: flex; gap: 1rem; flex-wrap: wrap;
}
.slot-info-row {
    display: flex; align-items: center; gap: .4rem;
    font-size: .9rem; font-weight: 600;
    color: var(--primary-color);
}
.slot-info-row i { font-size: 1.1rem; }

.form-label { display: flex; align-items: center; gap: .3rem; }
.form-label-icon { font-size: 1rem; color: var(--primary-color); }

.modal-actions { display: flex; gap: .6rem; margin-top: 1.25rem; flex-wrap: wrap; }
.btn-danger-outline {
    background: transparent;
    border: 1px solid var(--error);
    color: var(--error);
    display: inline-flex; align-items: center; gap: .3rem;
    padding: .65rem 1.2rem; border-radius: 8px;
    cursor: pointer; font-family: inherit; font-size: .9rem;
    transition: background .2s;
}
.btn-danger-outline:hover { background: rgba(183,28,28,.08); }

.excel-guide {
    background: var(--background); border-radius: 10px;
    padding: .85rem 1rem; margin-bottom: 1.1rem;
    font-size: .88rem; color: var(--text-secondary);
    display: flex; flex-direction: column; gap: .4rem;
}
.guide-title {
    display: flex; align-items: center; gap: .3rem;
    font-weight: 600; color: var(--text-primary);
    font-size: .9rem;
}
.guide-hint { color: var(--primary-color); font-weight: 500; }
.excel-guide code {
    background: rgba(0,0,0,.06); padding: .1rem .35rem;
    border-radius: 4px; font-size: .85em;
}
.excel-paste-area {
    font-family: 'Courier New', monospace;
    font-size: .85rem; resize: vertical;
    direction: ltr; text-align: left;
}
.paste-preview {
    background: var(--background); border-radius: 10px;
    padding: 1rem; margin-bottom: 1rem;
}
.paste-preview h4 {
    display: flex; align-items: center; gap: .4rem;
    font-size: .95rem; margin-bottom: .75rem; color: var(--primary-color);
}
.preview-table {
    width: 100%; font-size: .8rem; border-collapse: collapse; overflow-x: auto; display: block;
}
.preview-table th, .preview-table td {
    padding: .35rem .6rem; border: 1px solid var(--border-color);
    text-align: right;
}
.preview-table th { background: var(--primary-color); color: white; font-weight: 600; }
.preview-table tr:nth-child(even) td { background: rgba(0,0,0,.02); }
</style>

{% endblock %}

{% block scripts %}
<script>
function updateClock() {
    const now = new Date();
    const h = String(now.getHours()).padStart(2, '0');
    const m = String(now.getMinutes()).padStart(2, '0');
    const s = String(now.getSeconds()).padStart(2, '0');
    const el = document.getElementById('live-clock');
    if (el) el.textContent = `${h}:${m}:${s}`;
}
setInterval(updateClock, 1000);
updateClock();

function openTab(id, btn) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.dash-tab').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if (btn) btn.classList.add('active');
    if (id === 'reserve-room') {
        loadAvailableSlots();
    }
}

const dayMap = {
    'saturday':'Ø´Ù†Ø¨Ù‡', 'sunday':'ÛŒÚ©Ø´Ù†Ø¨Ù‡', 'monday':'Ø¯ÙˆØ´Ù†Ø¨Ù‡',
    'tuesday':'Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡', 'wednesday':'Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡'
};

const mySchedules = {{ schedules | tojson if schedules else '[]' }};

function renderSchedule() {
    document.querySelectorAll('#schedule-table .schedule-cell').forEach(cell => {
        cell.innerHTML = '';
        cell.classList.remove('has-class');
    });

    const grouped = {};
    mySchedules.forEach(item => {
        const key = `${item.day}__${item.time_slot}`;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(item);
    });

    Object.entries(grouped).forEach(([key, items]) => {
        const [day, time] = key.split('__');
        const cell = document.querySelector(
            `#schedule-table .schedule-cell[data-day="${day}"][data-time="${time}"]`
        );
        if (!cell) return;
        cell.classList.add('has-class');
        cell.innerHTML = buildCellHTML(items);
    });
}

function buildCellHTML(items) {
    if (items.length === 1 && items[0].week_type === 'all') {
        const item = items[0];
        return `<div class="cell-class-all">
            <div class="cell-name">${item.course_name || ''}</div>
            <div class="cell-info">${item.class_location || ''}${item.professor_name ? ' Â· ' + item.professor_name : ''}</div>
            <span class="cell-week-tag week-tag-all">Ù‡Ø± Ù‡ÙØªÙ‡</span>
        </div>`;
    }
    const oddItem = items.find(i => i.week_type === 'odd');
    const evenItem = items.find(i => i.week_type === 'even');

    let html = '<div class="cell-class-split">';
    if (oddItem) {
        html += `<div class="cell-half bg-odd">
            <div class="cell-name">${oddItem.course_name || ''}</div>
            <div class="cell-info">${oddItem.class_location || ''}${oddItem.professor_name ? ' Â· ' + oddItem.professor_name : ''}</div>
            <span class="cell-week-tag week-tag-odd">ÙØ±Ø¯</span>
        </div>`;
    } else {
        html += `<div class="cell-half" style="opacity:.3; display:flex; align-items:center; justify-content:center; font-size:.7rem;">ÙØ±Ø¯: Ø®Ø§Ù„ÛŒ</div>`;
    }
    if (evenItem) {
        html += `<div class="cell-half bg-even">
            <div class="cell-name">${evenItem.course_name || ''}</div>
            <div class="cell-info">${evenItem.class_location || ''}${evenItem.professor_name ? ' Â· ' + evenItem.professor_name : ''}</div>
            <span class="cell-week-tag week-tag-even">Ø²ÙˆØ¬</span>
        </div>`;
    } else {
        html += `<div class="cell-half" style="opacity:.3; display:flex; align-items:center; justify-content:center; font-size:.7rem;">Ø²ÙˆØ¬: Ø®Ø§Ù„ÛŒ</div>`;
    }
    html += '</div>';
    return html;
}

document.addEventListener('DOMContentLoaded', renderSchedule);
function openEditModal(cell) {
    const day = cell.dataset.day;
    const time = cell.dataset.time;

    document.getElementById('day-input').value = day;
    document.getElementById('time-input').value = time;
    document.getElementById('modal-title').textContent =
        `${dayMap[day]} â€” Ø³Ø§Ø¹Øª ${time.replace('-', ' ØªØ§ ')}`;
    document.getElementById('course-name').value = '';
    document.getElementById('professor-name').value = '';
    document.getElementById('class-location').value = '';
    document.querySelector('input[name="week_type"][value="all"]').checked = true;
    const existing = mySchedules.find(s => s.day === day && s.time_slot === time);
    if (existing) {
        document.getElementById('course-name').value = existing.course_name || '';
        document.getElementById('professor-name').value = existing.professor_name || '';
        document.getElementById('class-location').value = existing.class_location || '';
        const radioVal = existing.week_type || 'all';
        const radio = document.querySelector(`input[name="week_type"][value="${radioVal}"]`);
        if (radio) radio.checked = true;
    }

    openModal('edit-modal');
    setTimeout(() => document.getElementById('course-name').focus(), 150);
}

function handleScheduleSubmit(e) {
    e.preventDefault();
    const data = {
        day: document.getElementById('day-input').value,
        time_slot: document.getElementById('time-input').value,
        course_name: document.getElementById('course-name').value.trim(),
        class_location: document.getElementById('class-location').value.trim(),
        professor_name: document.getElementById('professor-name').value.trim(),
        week_type: document.querySelector('input[name="week_type"]:checked').value
    };

    saveScheduleItem(data, () => closeModal('edit-modal'));
}

function deleteClass() {
    const day = document.getElementById('day-input').value;
    const time = document.getElementById('time-input').value;

    if (!confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ú©Ù„Ø§Ø³ Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ')) return;

    saveScheduleItem({ day, time_slot: time, course_name: '' }, () => closeModal('edit-modal'));
}

function saveScheduleItem(data, onSuccess) {
    fetch('/update_schedule', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(resp => {
        if (resp.status === 'success') {
            const idx = mySchedules.findIndex(
                s => s.day === data.day && s.time_slot === data.time_slot
            );
            if (idx !== -1) mySchedules.splice(idx, 1);
            if (data.course_name) {
                mySchedules.push(data);
            }
            renderSchedule();
            if (onSuccess) onSuccess();
        } else {
            alert('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ: ' + (resp.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'));
        }
    })
    .catch(err => {
        console.error(err);
        alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
    });
}
function copyScheduleAsText() {
    const days = ['saturday','sunday','monday','tuesday','wednesday'];
    const dayNames = ['Ø´Ù†Ø¨Ù‡','ÛŒÚ©Ø´Ù†Ø¨Ù‡','Ø¯ÙˆØ´Ù†Ø¨Ù‡','Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡','Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡'];
    const times = ['8-10','10-12','12-14','14-16','16-18','18-20'];

    let text = 'Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ\n' + '='.repeat(50) + '\n\n';

    days.forEach((day, di) => {
        const daySchedules = mySchedules.filter(s => s.day === day);
        if (daySchedules.length === 0) return;
        text += `ğŸ“… ${dayNames[di]}\n`;
        daySchedules.sort((a, b) => times.indexOf(a.time_slot) - times.indexOf(b.time_slot));
        daySchedules.forEach(s => {
            const weekLabel = s.week_type === 'odd' ? '(ÙØ±Ø¯)' : s.week_type === 'even' ? '(Ø²ÙˆØ¬)' : '';
            text += `  â° ${s.time_slot.replace('-',' ØªØ§ ')}: `;
            text += s.course_name || '';
            if (s.professor_name) text += ` | Ø§Ø³ØªØ§Ø¯ ${s.professor_name}`;
            if (s.class_location) text += ` | ${s.class_location}`;
            if (weekLabel) text += ` ${weekLabel}`;
            text += '\n';
        });
        text += '\n';
    });

    if (!navigator.clipboard) {
        const ta = document.createElement('textarea');
        ta.value = text; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
    } else {
        navigator.clipboard.writeText(text);
    }

    const btn = event.target.closest('button');
    const original = btn.innerHTML;
    btn.innerHTML = '<i class="material-icons">check</i> Ú©Ù¾ÛŒ Ø´Ø¯!';
    btn.style.color = 'var(--success)';
    setTimeout(() => { btn.innerHTML = original; btn.style.color = ''; }, 2000);
}

let parsedScheduleData = [];

function openPasteModal() {
    document.getElementById('excel-paste-area').value = '';
    document.getElementById('paste-preview').style.display = 'none';
    document.getElementById('apply-paste-btn').disabled = true;
    parsedScheduleData = [];
    openModal('paste-modal');
    setTimeout(() => document.getElementById('excel-paste-area').focus(), 150);
}

function parseExcelPaste() {
    const raw = document.getElementById('excel-paste-area').value.trim();
    if (!raw) {
        document.getElementById('paste-preview').style.display = 'none';
        document.getElementById('apply-paste-btn').disabled = true;
        parsedScheduleData = [];
        return;
    }

    const rows = raw.split('\n').map(r => r.split('\t').map(c => c.trim()));

    parsedScheduleData = [];
    const dayKeywords = {
        'Ø´Ù†Ø¨Ù‡': 'saturday', 'Ø´Ù†Ø¨Ù‡': 'saturday',
        'ÛŒÚ©Ø´Ù†Ø¨Ù‡': 'sunday', 'ÙŠÚ©Ø´Ù†Ø¨Ù‡': 'sunday',
        'Ø¯ÙˆØ´Ù†Ø¨Ù‡': 'monday', 'Ø³Ù‡ Ø´Ù†Ø¨Ù‡': 'tuesday',
        'Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡': 'tuesday', 'Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡': 'wednesday',
        'sat': 'saturday', 'sun': 'sunday', 'mon': 'monday',
        'tue': 'tuesday', 'wed': 'wednesday'
    };
    const timePattern = /(\d{1,2})\s*[-â€“â€”]\s*(\d{1,2})/;
    const weekOddKeywords = ['ÙØ±Ø¯', 'odd', 'Ø²ÙˆØ¬ Ù†ÛŒØ³Øª'];
    const weekEvenKeywords = ['Ø²ÙˆØ¬', 'even'];

    let dayColumns = {};
    let headerRow = -1;

    rows.forEach((row, ri) => {
        row.forEach((cell, ci) => {
            const lower = cell.toLowerCase().trim();
            for (const [keyword, dayKey] of Object.entries(dayKeywords)) {
                if (lower === keyword || lower.includes(keyword)) {
                    if (!dayColumns[ci]) dayColumns[ci] = dayKey;
                    headerRow = ri;
                }
            }
        });
    });
    if (Object.keys(dayColumns).length > 0) {
        rows.forEach((row, ri) => {
            if (ri <= headerRow) return;
            if (!row.some(c => c)) return;
            const timeMatch = row[0] ? row[0].match(timePattern) : null;
            const timeSlot = timeMatch
                ? `${timeMatch[1]}-${timeMatch[2]}`
                : null;

            Object.entries(dayColumns).forEach(([ci, dayKey]) => {
                const cellVal = row[parseInt(ci)] || '';
                if (!cellVal) return;
                const parts = cellVal.split(/[|ØŒ,\n]/).map(p => p.trim()).filter(p => p);

                let courseName = parts[0] || '';
                let professorName = '';
                let classLocation = '';
                let weekType = 'all';
                parts.forEach((part, pi) => {
                    if (pi === 0) { courseName = part; return; }
                    const lowerPart = part.toLowerCase();
                    if (part.includes('Ø¯Ú©ØªØ±') || part.includes('Ù…Ù‡Ù†Ø¯Ø³') || part.includes('Ø§Ø³ØªØ§Ø¯') ||
                        part.includes('dr.') || part.includes('prof')) {
                        professorName = part.replace(/^Ø§Ø³ØªØ§Ø¯[:\s]*/i, '').trim();
                    }
                    else if (weekOddKeywords.some(k => lowerPart.includes(k))) {
                        weekType = 'odd';
                    }
                    else if (weekEvenKeywords.some(k => lowerPart.includes(k))) {
                        weekType = 'even';
                    }
                    else if (part.match(/\d+/) || lowerPart.includes('Ú©Ù„Ø§Ø³') ||
                             lowerPart.includes('Ø¢Ø²Ù…Ø§ÛŒØ´Ú¯Ø§Ù‡') || lowerPart.includes('Ø³Ø§Ù„Ù†') ||
                             lowerPart.includes('lab') || lowerPart.includes('room')) {
                        classLocation = part;
                    }
                    else if (!professorName && pi === 1) {
                        professorName = part;
                    }
                    else if (!classLocation && pi === 2) {
                        classLocation = part;
                    }
                });
                if (courseName && timeSlot) {
                    parsedScheduleData.push({
                        day: dayKey,
                        time_slot: timeSlot,
                        course_name: courseName,
                        professor_name: professorName,
                        class_location: classLocation,
                        week_type: weekType
                    });
                }
            });
        });
    } else {
        rows.forEach(row => {
            if (row.length < 3) return;
            const dayKey = Object.entries(dayKeywords).find(
                ([kw]) => row[0] && row[0].toLowerCase().includes(kw.toLowerCase())
            );
            if (!dayKey) return;

            const timeMatch = row[1] ? row[1].match(timePattern) : null;
            if (!timeMatch) return;

            parsedScheduleData.push({
                day: dayKey[1],
                time_slot: `${timeMatch[1]}-${timeMatch[2]}`,
                course_name: row[2] || '',
                professor_name: row[3] || '',
                class_location: row[4] || '',
                week_type: row[5] ? (weekOddKeywords.some(k => row[5].includes(k)) ? 'odd' :
                            weekEvenKeywords.some(k => row[5].includes(k)) ? 'even' : 'all') : 'all'
            });
        });
    }

    showPastePreview();
}

function showPastePreview() {
    const container = document.getElementById('paste-preview');
    const tableContainer = document.getElementById('paste-preview-table');

    if (parsedScheduleData.length === 0) {
        container.style.display = 'none';
        document.getElementById('apply-paste-btn').disabled = true;
        return;
    }

    container.style.display = 'block';
    container.querySelector('h4').innerHTML =
        `<i class="material-icons">preview</i> Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ (${parsedScheduleData.length} Ø±Ø¯ÛŒÙ ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯)`;
    document.getElementById('apply-paste-btn').disabled = false;

    const dayNames = {
        'saturday':'Ø´Ù†Ø¨Ù‡', 'sunday':'ÛŒÚ©Ø´Ù†Ø¨Ù‡', 'monday':'Ø¯ÙˆØ´Ù†Ø¨Ù‡',
        'tuesday':'Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡', 'wednesday':'Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡'
    };
    const weekNames = { 'all': 'Ù‡Ù…ÛŒØ´Ù‡', 'odd': 'ÙØ±Ø¯', 'even': 'Ø²ÙˆØ¬' };

    let html = `<div style="overflow-x:auto;"><table class="preview-table">
        <thead><tr>
            <th>Ø±ÙˆØ²</th><th>Ø³Ø§Ø¹Øª</th><th>Ù†Ø§Ù… Ø¯Ø±Ø³</th>
            <th>Ø§Ø³ØªØ§Ø¯</th><th>Ù…Ú©Ø§Ù†</th><th>Ù†ÙˆØ¹ Ù‡ÙØªÙ‡</th>
        </tr></thead><tbody>`;

    parsedScheduleData.forEach(item => {
        html += `<tr>
            <td>${dayNames[item.day] || item.day}</td>
            <td>${item.time_slot}</td>
            <td><strong>${item.course_name}</strong></td>
            <td>${item.professor_name || 'â€”'}</td>
            <td>${item.class_location || 'â€”'}</td>
            <td>${weekNames[item.week_type] || 'â€”'}</td>
        </tr>`;
    });

    html += '</tbody></table></div>';
    tableContainer.innerHTML = html;
}

function applyPastedSchedule() {
    if (parsedScheduleData.length === 0) return;

    if (!confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ ÙØ¹Ù„ÛŒ Ø´Ù…Ø§ Ù¾Ø§Ú© Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ ${parsedScheduleData.length} Ú©Ù„Ø§Ø³ Ø¬Ø¯ÛŒØ¯ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…ÛŒâ€ŒØ´ÙˆØ¯.`)) {
        return;
    }

    const btn = document.getElementById('apply-paste-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="material-icons">hourglass_empty</i> Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...';

    fetch('/bulk_update_schedule', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ schedules: parsedScheduleData })
    })
    .then(res => res.json())
    .then(resp => {
        if (resp.status === 'success') {
            closeModal('paste-modal');
            mySchedules.length = 0;
            parsedScheduleData.forEach(item => mySchedules.push(item));
            renderSchedule();
            const msg = document.createElement('div');
            msg.className = 'alert-banner-success';
            msg.innerHTML = `<i class="material-icons">check_circle</i> ${resp.count} Ú©Ù„Ø§Ø³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆØ§Ø±Ø¯ Ø´Ø¯.`;
            document.querySelector('.dashboard-container').insertAdjacentElement('afterbegin', msg);
            setTimeout(() => msg.remove(), 4000);
        } else {
            alert('Ø®Ø·Ø§: ' + (resp.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'));
            btn.disabled = false;
            btn.innerHTML = '<i class="material-icons">check</i> Ø§Ø¹Ù…Ø§Ù„ Ø¨Ø±Ù†Ø§Ù…Ù‡';
        }
    })
    .catch(() => {
        alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
        btn.disabled = false;
        btn.innerHTML = '<i class="material-icons">check</i> Ø§Ø¹Ù…Ø§Ù„ Ø¨Ø±Ù†Ø§Ù…Ù‡';
    });
}

function loadAvailableSlots() {
    document.querySelectorAll('#reservation-table .reserve-cell').forEach(cell => {
        cell.innerHTML = '<span class="cell-loading">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>';
    });

    fetch('/api/master_schedule')
        .then(res => res.json())
        .then(slots => {
            document.querySelectorAll('#reservation-table .reserve-cell').forEach(cell => {
                cell.innerHTML = '<span class="cell-empty-text">â€”</span>';
            });

            slots.forEach(slot => {
                const cell = document.querySelector(
                    `#reservation-table .reserve-cell[data-day="${slot.day}"][data-time="${slot.time_slot}"]`
                );
                if (!cell) return;

                if (slot.available_rooms.length > 0) {
                    let html = '';
                    slot.available_rooms.forEach(room => {
                        html += `<button class="room-pill"
                            onclick="openReserveModal(${slot.id}, '${room}', '${slot.day}', '${slot.time_slot}')">
                            ${room}
                        </button>`;
                    });
                    cell.innerHTML = html;
                } else if (slot.all_rooms.length > 0) {
                    cell.innerHTML = '<span class="cell-reserved-text">Ø±Ø²Ø±Ùˆ Ø´Ø¯Ù‡</span>';
                }
            });
        })
        .catch(() => {
            document.querySelectorAll('#reservation-table .reserve-cell').forEach(cell => {
                cell.innerHTML = '<span class="cell-empty-text" style="color:var(--error);">Ø®Ø·Ø§</span>';
            });
        });
}

function openReserveModal(slotId, room, day, time) {
    document.getElementById('reserve-room-display').textContent = `Ú©Ù„Ø§Ø³ ${room}`;
    document.getElementById('reserve-time-display').textContent =
        `${dayMap[day]} â€” Ø³Ø§Ø¹Øª ${time.replace('-', ' ØªØ§ ')}`;
    document.getElementById('reserve-reason').value = '';

    const form = document.getElementById('reserve-form');
    form.action = `/submit_reservation/${slotId}/${room}`;

    openModal('reserve-modal');
    setTimeout(() => document.getElementById('reserve-reason').focus(), 150);
}

function openModal(id) {
    const el = document.getElementById(id);
    el.classList.add('open');
    document.body.style.overflow = 'hidden';
}

function closeModal(id) {
    const el = document.getElementById(id);
    el.classList.remove('open');
    document.body.style.overflow = '';
}

function handleOverlayClick(event, id) {
    if (event.target.id === id) closeModal(id);
}

document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
        ['edit-modal', 'reserve-modal', 'paste-modal'].forEach(id => {
            const el = document.getElementById(id);
            if (el && el.classList.contains('open')) closeModal(id);
        });
    }
});

function markRead(notifId, el) {
    fetch(`/mark_notification_read/${notifId}`)
        .then(() => {
            if (el) {
                el.classList.remove('unread');
                el.style.opacity = '.6';
            }
        })
        .catch(() => {});
}

const style = document.createElement('style');
style.textContent = `
.alert-banner-success {
    display: flex; align-items: center; gap: .6rem;
    background: rgba(46,125,50,.1); border: 1px solid rgba(46,125,50,.3);
    border-right: 4px solid var(--success);
    border-radius: 10px; padding: .85rem 1.25rem;
    margin-bottom: 1rem; color: var(--success);
    font-weight: 600; animation: fadeIn .3s ease;
}`;
document.head.appendChild(style);
</script>
{% endblock %}