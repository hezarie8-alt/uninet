{% extends "base.html" %}

{% block title %}پنل مدیریت | یونی نت{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Tab Navigation -->
    <div class="form-card" style="margin-bottom: 2rem; padding: 0;">
        <div class="dashboard-tabs">
            <button class="dash-tab active" onclick="openAdminTab('master-schedule')">
                <i class="material-icons">grid_on</i> تعریف کلاس‌های خالی
            </button>
            <button class="dash-tab" onclick="openAdminTab('requests')">
                <i class="material-icons">list_alt</i> درخواست‌های رزرو
            </button>
            <button class="dash-tab" onclick="openAdminTab('cancelled')">
                <i class="material-icons">event_busy</i> لغو کلاس‌ها
            </button>
        </div>
    </div>

    <!-- 1. Master Schedule Definition -->
    <div id="master-schedule" class="tab-content active">
        <div class="schedule-card">
            <div class="card-header">
                <h2>تعریف کلاس‌های خالی پایه</h2>
                <button class="btn btn-custom" onclick="saveMasterSchedule()">
                    <i class="material-icons">save</i> ذخیره تغییرات
                </button>
            </div>
            <p style="color:var(--text-secondary); margin-bottom:1rem; font-size:0.9rem;">
                روی خانه مورد نظر کلیک کنید و شماره کلاس‌های خالی را با کاما وارد کنید (مثال: 101,102).
                <br>این برنامه تا پایان ترم معتبر است و هر هفته به صورت خودکار بازیابی می‌شود.
            </p>

            <div class="schedule-grid" id="master-schedule-grid">
                <!-- Header -->
                <div class="schedule-header"></div>
                <div class="schedule-header">شنبه</div>
                <div class="schedule-header">یکشنبه</div>
                <div class="schedule-header">دوشنبه</div>
                <div class="schedule-header">سه‌شنبه</div>
                <div class="schedule-header">چهارشنبه</div>

                <!-- Rows -->
                {% set times = ['8-10', '10-12', '12-14', '14-16', '16-18', '18-20'] %}
                {% set time_labels = ['۸ - ۱۰', '۱۰ - ۱۲', '۱۲ - ۱۴', '۱۴ - ۱۶', '۱۶ - ۱۸', '۱۸ - ۲۰'] %}
                
                {% for i in range(6) %}
                    <div class="schedule-time">{{ time_labels[i] }}</div>
                    {% for day in ['saturday', 'sunday', 'monday', 'tuesday', 'wednesday'] %}
                        <div class="schedule-cell master-cell" data-day="{{ day }}" data-time="{{ times[i] }}" onclick="editMasterSlot(this)">
                            <!-- Populated by JS -->
                        </div>
                    {% endfor %}
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- 2. Reservation Requests -->
    <div id="requests" class="tab-content">
        <div class="schedule-card">
            <h2 style="font-size: 1.25rem; margin-bottom: 1rem;">
                <i class="material-icons" style="vertical-align: middle;">pending_actions</i>
                درخواست‌های در انتظار تایید
            </h2>
            
            <div style="display: grid; gap: 1rem;">
                {% if requests %}
                    {% for req in requests %}
                        <div class="request-card">
                            <div class="req-header">
                                <div>
                                    <strong style="font-size: 1.1rem;">{{ req.user.full_name }}</strong>
                                    <span style="color: var(--text-secondary); font-size: 0.9rem; margin-right: 0.5rem;">
                                        ({{ req.user.student_id }})
                                    </span>
                                </div>
                                <div class="req-room-badge">
                                    کلاس {{ req.room_name }}
                                </div>
                            </div>
                            <div class="req-body">
                                <div class="req-info">
                                    <span><i class="material-icons">access_time</i> {{ req.master_slot.day }} - {{ req.master_slot.time_slot }}</span>
                                    <span style="margin-top:0.5rem;"><i class="material-icons">description</i> {{ req.reason }}</span>
                                </div>
                            </div>
                            <div class="req-actions">
                                <a href="{{ url_for('handle_reservation', req_id=req.id, action='approve') }}" class="btn btn-custom btn-success">
                                    <i class="material-icons">check</i> تایید
                                </a>
                                <a href="{{ url_for('handle_reservation', req_id=req.id, action='reject') }}" class="btn btn-outline btn-danger">
                                    <i class="material-icons">close</i> رد
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <i class="material-icons">check_circle</i>
                        <p>هیچ درخواستی در انتظار نیست.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 3. Cancelled Classes -->
    <div id="cancelled" class="tab-content">
        <div class="schedule-card">
            <h2 style="font-size: 1.25rem; margin-bottom: 1rem;">
                <i class="material-icons" style="vertical-align: middle;">event_busy</i>
                ثبت کلاس لغو شده
            </h2>
            
            <form action="{{ url_for('add_cancelled_class') }}" method="POST" class="cancelled-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>نام استاد</label>
                        <input type="text" name="professor" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>نام درس</label>
                        <input type="text" name="course" class="form-control" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>توضیحات (مثلاً: کلاس با جلسه تمرین جابجا شد)</label>
                    <input type="text" name="desc" class="form-control">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>تاریخ دقیق لغو (اختیاری)</label>
                        <input type="date" name="date" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>از تاریخ (برای بازه)</label>
                        <input type="date" name="start_date" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>تا تاریخ (برای بازه)</label>
                        <input type="date" name="end_date" class="form-control">
                    </div>
                </div>

                <button type="submit" class="btn btn-custom">ثبت لغو کلاس</button>
            </form>

            <hr style="margin: 2rem 0; border-color: var(--border-color);">

            <h3>لیست لغوهای ثبت شده</h3>
            <div class="cancelled-list">
                {% if cancelled_classes %}
                    {% for c in cancelled_classes %}
                        <div class="cancelled-item">
                            <div>
                                <strong>{{ c.course_name }}</strong> - استاد {{ c.professor_name }}
                                <br>
                                <small style="color:var(--text-secondary)">
                                    {% if c.cancel_date %}
                                        تاریخ: {{ c.cancel_date }}
                                    {% elif c.start_date %}
                                        بازه: {{ c.start_date }} تا {{ c.end_date }}
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p style="text-align:center; color:var(--text-secondary);">لیست خالی است.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal for Master Schedule Edit -->
<div id="master-modal" class="modal-box">
    <div class="form-card modal-content">
        <h3>تعریف کلاس‌های خالی</h3>
        <p style="font-size:0.9rem; color:var(--text-secondary); margin-bottom:1rem;" id="master-slot-info"></p>
        
        <div class="form-group">
            <label class="form-label">شماره کلاس‌ها (با کاما جدا کنید)</label>
            <input type="text" id="master-rooms-input" class="form-control" placeholder="مثال: 101, 102, آمفی">
        </div>
        
        <div class="modal-actions">
            <button class="btn btn-custom" onclick="saveSlotData()">ذخیره</button>
            <button class="btn btn-outline" onclick="closeModal('master-modal')">لغو</button>
        </div>
    </div>
</div>

<style>
    /* Master Schedule Specifics */
    .master-cell { cursor: pointer; transition: all 0.2s; min-height: 60px; }
    .master-cell:hover { background-color: var(--primary-light); color: white; }
    .master-cell.has-data { background-color: rgba(0, 131, 143, 0.1); border-right: 3px solid var(--primary-color); }
    
    /* Request Card */
    .request-card {
        border: 1px solid var(--border-color);
        padding: 1rem;
        border-radius: 8px;
        background: var(--surface);
        transition: box-shadow 0.3s;
    }
    .request-card:hover { box-shadow: var(--shadow-md); }
    .req-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .req-room-badge { background: var(--primary-color); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; }
    .req-body { margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.75rem; }
    .req-info { display: flex; flex-direction: column; gap: 0.25rem; font-size: 0.9rem; }
    .req-info span { display: flex; align-items: center; gap: 0.5rem; }
    .req-actions { display: flex; gap: 0.5rem; justify-content: flex-end; }
    
    /* Buttons */
    .btn-success { background-color: var(--success) !important; color: white !important; }
    .btn-danger { color: var(--error) !important; border-color: var(--error) !important; }

    /* Cancelled Form */
    .cancelled-form { background: var(--background); padding: 1.5rem; border-radius: 8px; }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
    
    .cancelled-list { margin-top: 1rem; }
    .cancelled-item { padding: 0.75rem; border-right: 3px solid var(--error); background: rgba(183, 28, 28, 0.05); margin-bottom: 0.5rem; border-radius: 4px; }

    .empty-state { text-align: center; padding: 2rem; color: var(--text-secondary); }
    .empty-state i { font-size: 3rem; margin-bottom: 0.5rem; color: var(--success); }
</style>

{% endblock %}

{% block scripts %}
<script>
    // --- 1. Tab Logic ---
    function openAdminTab(id) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.dash-tab').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.target.closest('.dash-tab').classList.add('active');
    }

    // --- 2. Master Schedule Logic ---
    // Data from backend: list of {day, time_slot, rooms}
    const masterData = {% if slots %}{{ slots | tojson }}{% else %}[]{% endif %};
    
    // Populate grid on load
    document.addEventListener('DOMContentLoaded', () => {
        masterData.forEach(item => {
            const cell = document.querySelector(`.master-cell[data-day="${item.day}"][data-time="${item.time_slot}"]`);
            if (cell) {
                cell.innerHTML = `<div style="font-size:0.8rem; font-weight:600; color:var(--primary-color);">${item.rooms}</div>`;
                cell.classList.add('has-data');
                cell.dataset.rooms = item.rooms;
            }
        });
    });

    let activeCell = null;

    function editMasterSlot(cell) {
        activeCell = cell;
        const day = cell.dataset.day;
        const time = cell.dataset.time;
        const dayNames = {'saturday':'شنبه', 'sunday':'یکشنبه', 'monday':'دوشنبه', 'tuesday':'سه‌شنبه', 'wednesday':'چهارشنبه'};
        
        document.getElementById('master-slot-info').innerText = `${dayNames[day]} - ساعت ${time}`;
        document.getElementById('master-rooms-input').value = cell.dataset.rooms || "";
        document.getElementById('master-modal').style.display = 'flex';
    }

    function saveSlotData() {
        const rooms = document.getElementById('master-rooms-input').value;
        if (activeCell) {
            activeCell.dataset.rooms = rooms;
            if (rooms.trim()) {
                activeCell.innerHTML = `<div style="font-size:0.8rem; font-weight:600; color:var(--primary-color);">${rooms}</div>`;
                activeCell.classList.add('has-data');
            } else {
                activeCell.innerHTML = '';
                activeCell.classList.remove('has-data');
            }
        }
        closeModal('master-modal');
    }

    function saveMasterSchedule() {
        // Gather all data
        const payload = [];
        document.querySelectorAll('.master-cell').forEach(cell => {
            if (cell.dataset.rooms && cell.dataset.rooms.trim() !== "") {
                payload.push({
                    day: cell.dataset.day,
                    time_slot: cell.dataset.time,
                    rooms: cell.dataset.rooms.trim()
                });
            }
        });

        fetch('/admin/save_master_schedule', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(resp => {
            if (resp.status === 'success') {
                alert('برنامه کلاس‌های خالی با موفقیت ذخیره شد.');
                location.reload();
            }
        });
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    window.onclick = function(event) {
        if (event.target.classList.contains('modal-box')) {
            event.target.style.display = 'none';
        }
    }
</script>
{% endblock %}