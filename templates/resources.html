{% extends "base.html" %}

{% block title %}منابع درسی | یونی نت{% endblock %}

{% block content %}
<div class="resources-page">

    <!-- ═══════ Page Header ═══════ -->
    <div class="res-header">
        <div class="res-header-info">
            <div class="res-header-icon">
                <i class="material-icons">library_books</i>
            </div>
            <div>
                <h1 class="res-title">منابع درسی</h1>
                <p class="res-subtitle">اشتراک‌گذاری جزوه، اسلاید و نمونه‌سؤال بین دانشجویان</p>
            </div>
        </div>
        <button class="btn btn-custom res-upload-btn" onclick="openUploadModal()">
            <i class="material-icons">cloud_upload</i>
            <span>آپلود منبع جدید</span>
        </button>
    </div>

    <!-- ═══════ Toolbar: Search + Filters + View + Sort ═══════ -->
    <div class="res-toolbar">
        <!-- Search -->
        <div class="res-search-wrap">
            <i class="material-icons res-search-icon">search</i>
            <input type="text" id="res-search-input" class="res-search-input"
                   placeholder="جستجو در منابع یا نام درس..."
                   oninput="debounceSearch()">
            <button class="res-search-clear hidden" id="search-clear-btn" onclick="clearSearch()">
                <i class="material-icons">close</i>
            </button>
        </div>

        <div class="res-toolbar-right">
            <!-- Type Filters -->
            <div class="res-filter-chips" id="type-filter-chips">
                <button class="res-chip active" data-type="" onclick="setTypeFilter('', this)">همه</button>
                <button class="res-chip" data-type="notes"
                        onclick="setTypeFilter('notes', this)">
                    <span class="chip-dot" style="background:var(--type-notes)"></span> جزوه
                </button>
                <button class="res-chip" data-type="slides"
                        onclick="setTypeFilter('slides', this)">
                    <span class="chip-dot" style="background:var(--type-slides)"></span> اسلاید
                </button>
                <button class="res-chip" data-type="sample_questions"
                        onclick="setTypeFilter('sample_questions', this)">
                    <span class="chip-dot" style="background:var(--type-sample)"></span> نمونه‌سؤال
                </button>
                <button class="res-chip" data-type="book"
                        onclick="setTypeFilter('book', this)">
                    <span class="chip-dot" style="background:var(--type-book)"></span> کتاب
                </button>
            </div>

            <!-- Sort -->
            <div class="res-sort-wrap">
                <i class="material-icons" style="font-size:1rem;color:var(--text-secondary);">sort</i>
                <select id="sort-select" class="res-sort-select" onchange="applyFiltersAndRender()">
                    <option value="newest">جدیدترین</option>
                    <option value="popular">محبوب‌ترین</option>
                    <option value="name">نام فایل</option>
                </select>
            </div>

            <!-- View Toggle -->
            <div class="view-toggle">
                <button class="view-btn active" id="view-grid-btn"
                        onclick="setView('grid')" title="نمایش شبکه‌ای">
                    <i class="material-icons">grid_view</i>
                </button>
                <button class="view-btn" id="view-list-btn"
                        onclick="setView('list')" title="نمایش لیستی">
                    <i class="material-icons">view_list</i>
                </button>
            </div>
        </div>
    </div>

    <!-- ═══════ Stats Bar ═══════ -->
    <div class="res-stats-bar" id="res-stats-bar">
        <span id="stats-total" class="stat-item">
            <i class="material-icons">folder</i> در حال بارگذاری...
        </span>
    </div>

    <!-- ═══════ Resources Container ═══════ -->
    <div id="resources-container">
        <div class="loading-state-res">
            <i class="material-icons spin-anim">sync</i>
            <span>در حال بارگذاری منابع...</span>
        </div>
    </div>

</div><!-- /resources-page -->

<!-- ═══════════════════════════════════════════
     Upload Modal
═══════════════════════════════════════════ -->
<div id="upload-modal" class="res-modal-overlay" onclick="if(event.target===this)closeUploadModal()">
    <div class="res-modal-card">
        <div class="res-modal-header">
            <h3><i class="material-icons">cloud_upload</i> آپلود منبع جدید</h3>
            <button class="res-modal-close" onclick="closeUploadModal()">
                <i class="material-icons">close</i>
            </button>
        </div>

        <div class="res-modal-body">

            <!-- DropZone -->
            <div class="dropzone" id="dropzone"
                 ondragover="handleDragOver(event)"
                 ondragleave="handleDragLeave(event)"
                 ondrop="handleDrop(event)"
                 onclick="document.getElementById('file-input').click()">
                <div class="dropzone-content" id="dropzone-content">
                    <div class="dropzone-icon">
                        <i class="material-icons">upload_file</i>
                    </div>
                    <div class="dropzone-text">
                        <strong>فایل را اینجا رها کنید</strong>
                        <span>یا کلیک کنید تا انتخاب کنید</span>
                    </div>
                    <div class="dropzone-formats">
                        PDF &nbsp;·&nbsp; DOCX &nbsp;·&nbsp; PPTX &nbsp;·&nbsp; ZIP
                        <br><span style="font-size:.75rem;">حداکثر ۵۰ مگابایت</span>
                    </div>
                </div>
                <!-- وقتی فایل انتخاب شد نمایش داده می‌شود -->
                <div class="dropzone-selected hidden" id="dropzone-selected">
                    <div class="file-preview-icon" id="file-preview-icon">
                        <i class="material-icons">description</i>
                    </div>
                    <div class="file-preview-info">
                        <div class="file-preview-name" id="file-preview-name">—</div>
                        <div class="file-preview-size" id="file-preview-size">—</div>
                    </div>
                    <button type="button" class="file-remove-btn" onclick="clearFileSelection(event)">
                        <i class="material-icons">close</i>
                    </button>
                </div>
            </div>
            <input type="file" id="file-input" class="hidden"
                   accept=".pdf,.docx,.pptx,.zip"
                   onchange="handleFileSelect(event)">

            <!-- عنوان -->
            <div class="up-form-group">
                <label class="up-form-label">
                    <i class="material-icons">title</i> عنوان منبع <span class="req">*</span>
                </label>
                <input type="text" id="up-title" class="up-form-input"
                       placeholder="مثال: جزوه کامل ریاضی مهندسی — فصل ۱ تا ۵">
            </div>

            <!-- درس -->
            <div class="up-form-group">
                <label class="up-form-label">
                    <i class="material-icons">menu_book</i> نام درس <span class="req">*</span>
                </label>
                <div class="course-input-wrap">
                    <input type="text" id="up-course" class="up-form-input"
                           placeholder="مثال: ریاضی مهندسی"
                           oninput="showCourseSuggestions()"
                           autocomplete="off">
                    <div class="course-suggestions hidden" id="course-suggestions"></div>
                </div>
            </div>

            <!-- نوع منبع -->
            <div class="up-form-group">
                <label class="up-form-label">
                    <i class="material-icons">category</i> نوع منبع <span class="req">*</span>
                </label>
                <div class="type-chips-upload">
                    <label class="type-chip-up">
                        <input type="radio" name="up-type" value="notes" checked>
                        <span style="--chip-color:var(--type-notes)">
                            <i class="material-icons">sticky_note_2</i> جزوه
                        </span>
                    </label>
                    <label class="type-chip-up">
                        <input type="radio" name="up-type" value="slides">
                        <span style="--chip-color:var(--type-slides)">
                            <i class="material-icons">slideshow</i> اسلاید
                        </span>
                    </label>
                    <label class="type-chip-up">
                        <input type="radio" name="up-type" value="sample_questions">
                        <span style="--chip-color:var(--type-sample)">
                            <i class="material-icons">quiz</i> نمونه‌سؤال
                        </span>
                    </label>
                    <label class="type-chip-up">
                        <input type="radio" name="up-type" value="book">
                        <span style="--chip-color:var(--type-book)">
                            <i class="material-icons">book</i> کتاب
                        </span>
                    </label>
                </div>
            </div>

        </div>

        <div class="res-modal-footer">
            <button class="btn btn-custom" id="upload-submit-btn" onclick="submitUpload()">
                <i class="material-icons">cloud_upload</i> آپلود
            </button>
            <button class="btn btn-outline" onclick="closeUploadModal()">انصراف</button>
        </div>

        <!-- Progress Bar -->
        <div class="upload-progress hidden" id="upload-progress">
            <div class="upload-progress-bar" id="upload-progress-bar"></div>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════
     CSS
═══════════════════════════════════════════ -->
<style>
/* ── Color Tokens for Resource Types ── */
:root {
    --type-notes:   #00838F;  /* جزوه    → تیل */
    --type-slides:  #1565C0;  /* اسلاید  → آبی */
    --type-sample:  #E53935;  /* نمونه   → قرمز */
    --type-book:    #6D4C41;  /* کتاب    → قهوه‌ای */
}

/* ── Page ── */
.resources-page { max-width: 1200px; margin: 0 auto; padding-bottom: 3rem; }

/* ── Header ── */
.res-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;
}
.res-header-info { display: flex; align-items: center; gap: 1rem; }
.res-header-icon {
    width: 52px; height: 52px; border-radius: 14px;
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 16px rgba(0,131,143,.3);
    flex-shrink: 0;
}
.res-header-icon i { color: white; font-size: 1.6rem; }
.res-title  { font-size: 1.5rem; font-weight: 800; margin: 0 0 .15rem; }
.res-subtitle { font-size: .88rem; color: var(--text-secondary); margin: 0; }
.res-upload-btn { display: flex; align-items: center; gap: .4rem; white-space: nowrap; }

/* ── Toolbar ── */
.res-toolbar {
    display: flex; gap: 1rem; margin-bottom: 1rem;
    align-items: center; flex-wrap: wrap;
}
.res-search-wrap {
    flex: 1; min-width: 220px;
    position: relative; display: flex; align-items: center;
}
.res-search-icon {
    position: absolute; right: .85rem;
    color: var(--text-secondary); font-size: 1.2rem; pointer-events: none;
}
.res-search-input {
    width: 100%; padding: .65rem .85rem .65rem 2.5rem;
    padding-right: 2.6rem;
    border: 1.5px solid var(--border-color); border-radius: 12px;
    background: var(--surface); font-family: inherit; font-size: .9rem;
    color: var(--text-primary); outline: none;
    transition: border-color .18s, box-shadow .18s;
}
.res-search-input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(0,131,143,.1);
}
.res-search-clear {
    position: absolute; left: .6rem;
    background: none; border: none; cursor: pointer;
    color: var(--text-secondary); display: flex; align-items: center;
    border-radius: 50%; padding: .15rem;
    transition: color .18s;
}
.res-search-clear:hover { color: var(--error); }

.res-toolbar-right {
    display: flex; align-items: center; gap: .75rem; flex-wrap: wrap;
}

/* ── Filter Chips ── */
.res-filter-chips { display: flex; gap: .4rem; flex-wrap: wrap; }
.res-chip {
    display: inline-flex; align-items: center; gap: .35rem;
    padding: .35rem .85rem; border-radius: 20px;
    border: 1.5px solid var(--border-color); background: var(--surface);
    font-family: inherit; font-size: .8rem; font-weight: 600;
    color: var(--text-secondary); cursor: pointer; transition: all .18s;
}
.res-chip:hover { border-color: var(--primary-color); color: var(--primary-color); }
.res-chip.active { background: var(--primary-color); border-color: var(--primary-color); color: white; }
.chip-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }

/* ── Sort & View ── */
.res-sort-wrap {
    display: flex; align-items: center; gap: .4rem;
    border: 1.5px solid var(--border-color); border-radius: 10px;
    padding: .35rem .7rem; background: var(--surface);
}
.res-sort-select {
    border: none; background: none; font-family: inherit;
    font-size: .82rem; color: var(--text-primary); cursor: pointer;
    outline: none; padding: 0;
}
.view-toggle {
    display: flex; border: 1.5px solid var(--border-color);
    border-radius: 10px; overflow: hidden; background: var(--surface);
}
.view-btn {
    padding: .4rem .65rem; border: none; background: none;
    cursor: pointer; display: flex; align-items: center;
    color: var(--text-secondary); transition: all .18s;
}
.view-btn:hover { background: var(--background); color: var(--primary-color); }
.view-btn.active { background: var(--primary-color); color: white; }

/* ── Stats Bar ── */
.res-stats-bar {
    display: flex; align-items: center; gap: 1.5rem;
    margin-bottom: 1.25rem; padding: .5rem .75rem;
    background: var(--surface); border-radius: 10px;
    border: 1px solid var(--border-color);
    font-size: .82rem; color: var(--text-secondary);
    flex-wrap: wrap;
}
.stat-item { display: flex; align-items: center; gap: .3rem; }
.stat-item i { font-size: .95rem; color: var(--primary-color); }

/* ── Course Section ── */
.course-section { margin-bottom: 1.5rem; }
.course-section-header {
    display: flex; align-items: center; gap: .65rem;
    padding: .75rem 1rem; cursor: pointer;
    background: var(--surface); border: 1px solid var(--border-color);
    border-radius: 12px; transition: border-color .18s, box-shadow .18s;
    user-select: none;
}
.course-section-header:hover {
    border-color: rgba(0,131,143,.3);
    box-shadow: var(--shadow-sm);
}
.course-section-header.open { border-bottom-left-radius: 0; border-bottom-right-radius: 0; border-bottom-color: transparent; }
.course-icon { color: var(--primary-color); font-size: 1.3rem; }
.course-name { font-weight: 700; font-size: 1rem; flex: 1; }
.course-count {
    background: rgba(0,131,143,.12); color: var(--primary-color);
    padding: .15rem .6rem; border-radius: 20px;
    font-size: .75rem; font-weight: 700;
}
.course-toggle-icon { color: var(--text-secondary); transition: transform .25s; }
.course-section-header.open .course-toggle-icon { transform: rotate(90deg); }

.course-body {
    display: none;
    border: 1px solid var(--border-color); border-top: none;
    border-bottom-left-radius: 12px; border-bottom-right-radius: 12px;
    padding: 1rem; background: var(--background);
}
.course-body.open { display: block; animation: slideDown .2s ease; }
@keyframes slideDown { from{opacity:0;transform:translateY(-6px)} to{opacity:1;transform:translateY(0)} }

/* ── Grid View ── */
.res-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: .85rem;
}

/* ── List View ── */
.res-list { display: flex; flex-direction: column; gap: .6rem; }

/* ── Resource Card (Grid) ── */
.res-card {
    background: var(--surface); border: 1px solid var(--border-color);
    border-radius: 14px; padding: 1rem;
    display: flex; flex-direction: column; gap: .7rem;
    transition: box-shadow .2s, border-color .2s, transform .15s;
    position: relative; overflow: hidden;
}
.res-card::before {
    content: '';
    position: absolute; top: 0; right: 0;
    width: 4px; height: 100%;
    background: var(--card-type-color, var(--primary-color));
    border-radius: 0 14px 14px 0;
}
.res-card:hover {
    box-shadow: var(--shadow-md); border-color: rgba(0,131,143,.25);
    transform: translateY(-2px);
}

.res-card-top { display: flex; align-items: flex-start; gap: .75rem; }
.res-card-file-icon {
    width: 44px; height: 44px; border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; font-size: 0;
}
.res-card-file-icon i { font-size: 1.6rem; }
.res-card-meta { flex: 1; min-width: 0; }
.res-card-title {
    font-weight: 700; font-size: .9rem; line-height: 1.35;
    display: -webkit-box; -webkit-line-clamp: 2;
    -webkit-box-orient: vertical; overflow: hidden;
    margin-bottom: .25rem;
}
.type-badge {
    display: inline-flex; align-items: center; gap: .25rem;
    font-size: .72rem; font-weight: 700; padding: .15rem .55rem;
    border-radius: 20px;
}
.res-card-divider { border: none; border-top: 1px solid var(--border-color); margin: 0; }

.res-card-info {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: .3rem .5rem; font-size: .76rem; color: var(--text-secondary);
}
.res-card-info-item { display: flex; align-items: center; gap: .2rem; }
.res-card-info-item i { font-size: .85rem; }

.res-card-footer { display: flex; justify-content: space-between; align-items: center; }
.res-card-uploader { display: flex; align-items: center; gap: .4rem; font-size: .75rem; color: var(--text-secondary); }
.uploader-avatar {
    width: 22px; height: 22px; border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    color: white; display: flex; align-items: center; justify-content: center;
    font-size: .65rem; font-weight: 700; flex-shrink: 0;
}
.res-card-actions { display: flex; gap: .35rem; }
.res-action-btn {
    display: flex; align-items: center; gap: .25rem;
    padding: .3rem .65rem; border-radius: 8px;
    border: 1px solid var(--border-color); background: var(--background);
    cursor: pointer; font-family: inherit; font-size: .76rem; font-weight: 600;
    color: var(--text-secondary); transition: all .18s;
}
.res-action-btn i { font-size: .9rem; }
.res-action-btn:hover { border-color: var(--primary-color); color: var(--primary-color); background: rgba(0,131,143,.06); }
.res-action-btn.liked { border-color: var(--error); color: var(--error); background: rgba(183,28,28,.07); }
.res-action-btn.download-btn:hover { border-color: var(--success); color: var(--success); background: rgba(46,125,50,.06); }
.res-action-btn.delete-btn:hover { border-color: var(--error); color: var(--error); background: rgba(183,28,28,.06); }

/* ── Resource Row (List View) ── */
.res-row {
    display: flex; align-items: center; gap: .85rem;
    background: var(--surface); border: 1px solid var(--border-color);
    border-radius: 12px; padding: .75rem 1rem;
    transition: box-shadow .18s, border-color .18s;
}
.res-row:hover { box-shadow: var(--shadow-sm); border-color: rgba(0,131,143,.2); }
.res-row-icon {
    width: 38px; height: 38px; border-radius: 10px;
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.res-row-icon i { font-size: 1.3rem; }
.res-row-info { flex: 1; min-width: 0; }
.res-row-title { font-weight: 700; font-size: .9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.res-row-meta { display: flex; align-items: center; gap: .75rem; margin-top: .2rem; flex-wrap: wrap; }
.res-row-meta-item { display: flex; align-items: center; gap: .2rem; font-size: .75rem; color: var(--text-secondary); }
.res-row-meta-item i { font-size: .85rem; }
.res-row-actions { display: flex; gap: .3rem; flex-shrink: 0; }

/* ── Loading / Empty ── */
.loading-state-res {
    display: flex; align-items: center; gap: .65rem;
    color: var(--text-secondary); padding: 3rem;
    justify-content: center; font-size: .9rem;
}
.spin-anim { animation: spin 1s linear infinite; }
.empty-res-state {
    text-align: center; padding: 4rem 1rem;
    color: var(--text-secondary);
}
.empty-res-state i { font-size: 4rem; color: var(--border-color); display: block; margin-bottom: .75rem; }
.empty-res-state h3 { color: var(--text-primary); margin-bottom: .5rem; }

/* ── Upload Modal ── */
.res-modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,.45); backdrop-filter: blur(4px);
    z-index: 2000; align-items: center; justify-content: center; padding: 1rem;
}
.res-modal-overlay.open { display: flex; animation: modalIn .25s ease; }
@keyframes modalIn { from{opacity:0;transform:scale(.97)} to{opacity:1;transform:scale(1)} }

.res-modal-card {
    background: var(--surface); border-radius: 20px; padding: 1.75rem;
    width: 100%; max-width: 520px; box-shadow: 0 24px 64px rgba(0,0,0,.2);
    max-height: 92vh; overflow-y: auto; border: 1px solid var(--border-color);
}
.res-modal-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 1.5rem;
}
.res-modal-header h3 {
    display: flex; align-items: center; gap: .4rem;
    font-size: 1.1rem; font-weight: 800; margin: 0; color: var(--primary-color);
}
.res-modal-close {
    width: 34px; height: 34px; border-radius: 50%;
    border: 1px solid var(--border-color); background: var(--background);
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    color: var(--text-secondary); transition: all .18s;
}
.res-modal-close:hover { border-color: var(--error); color: var(--error); }
.res-modal-body { display: flex; flex-direction: column; gap: 1.1rem; }
.res-modal-footer { display: flex; gap: .75rem; margin-top: 1.5rem; }

/* ── Dropzone ── */
.dropzone {
    border: 2px dashed var(--border-color); border-radius: 14px;
    padding: 1.5rem; text-align: center; cursor: pointer;
    background: var(--background); transition: all .2s; position: relative;
    min-height: 130px; display: flex; align-items: center; justify-content: center;
}
.dropzone:hover, .dropzone.drag-over {
    border-color: var(--primary-color);
    background: rgba(0,131,143,.04);
}
.dropzone.has-file { border-style: solid; border-color: var(--primary-color); background: rgba(0,131,143,.04); }
.dropzone-content { display: flex; flex-direction: column; align-items: center; gap: .65rem; }
.dropzone-icon i { font-size: 2.8rem; color: var(--primary-color); opacity: .6; }
.dropzone-text strong { display: block; font-size: .95rem; color: var(--text-primary); }
.dropzone-text span  { display: block; font-size: .82rem; color: var(--text-secondary); }
.dropzone-formats { font-size: .8rem; color: var(--text-secondary); background: var(--surface); padding: .3rem .85rem; border-radius: 20px; border: 1px solid var(--border-color); }
.dropzone-selected {
    display: flex; align-items: center; gap: 1rem; width: 100%; padding: .5rem;
}
.file-preview-icon {
    width: 48px; height: 48px; border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    background: rgba(0,131,143,.12); color: var(--primary-color);
    flex-shrink: 0;
}
.file-preview-icon i { font-size: 1.6rem; }
.file-preview-info { flex: 1; text-align: right; min-width: 0; }
.file-preview-name { font-weight: 700; font-size: .9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.file-preview-size { font-size: .78rem; color: var(--text-secondary); margin-top: .15rem; }
.file-remove-btn {
    width: 28px; height: 28px; border-radius: 50%;
    border: 1px solid var(--border-color); background: var(--surface);
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    color: var(--text-secondary); flex-shrink: 0; transition: all .18s;
}
.file-remove-btn:hover { border-color: var(--error); color: var(--error); }

/* ── Upload Form ── */
.up-form-group { display: flex; flex-direction: column; gap: .4rem; }
.up-form-label {
    display: flex; align-items: center; gap: .3rem;
    font-size: .88rem; font-weight: 700;
}
.up-form-label i { font-size: .95rem; color: var(--primary-color); }
.req { color: var(--error); }
.up-form-input {
    border: 1.5px solid var(--border-color); border-radius: 10px;
    padding: .65rem .9rem; font-family: inherit; font-size: .9rem;
    background: var(--background); color: var(--text-primary);
    transition: border-color .18s, box-shadow .18s; outline: none;
    width: 100%; box-sizing: border-box;
}
.up-form-input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0,131,143,.1); }

.course-input-wrap { position: relative; }
.course-suggestions {
    position: absolute; top: calc(100% + 4px); right: 0; left: 0; z-index: 100;
    background: var(--surface); border: 1px solid var(--border-color);
    border-radius: 10px; box-shadow: var(--shadow-md); max-height: 180px; overflow-y: auto;
}
.course-suggestion-item {
    padding: .55rem .9rem; cursor: pointer; font-size: .88rem;
    transition: background .15s; display: flex; align-items: center; gap: .5rem;
}
.course-suggestion-item:hover { background: rgba(0,131,143,.07); color: var(--primary-color); }
.course-suggestion-item i { font-size: .95rem; color: var(--primary-color); }

/* ── Type Chips (Upload Modal) ── */
.type-chips-upload { display: flex; flex-wrap: wrap; gap: .5rem; }
.type-chip-up { cursor: pointer; }
.type-chip-up input { display: none; }
.type-chip-up span {
    display: inline-flex; align-items: center; gap: .3rem;
    padding: .45rem 1rem; border-radius: 20px;
    border: 1.5px solid var(--border-color); background: var(--background);
    font-size: .83rem; font-weight: 600; color: var(--text-secondary);
    cursor: pointer; transition: all .18s;
}
.type-chip-up span i { font-size: .95rem; }
.type-chip-up input:checked + span {
    border-color: var(--chip-color);
    background: color-mix(in srgb, var(--chip-color) 12%, transparent);
    color: var(--chip-color);
}
.type-chip-up:hover span { border-color: var(--chip-color); color: var(--chip-color); }

/* ── Upload Progress ── */
.upload-progress {
    margin-top: 1rem; border-radius: 10px; overflow: hidden;
    background: var(--border-color); height: 6px;
}
.upload-progress-bar {
    height: 100%; border-radius: 10px;
    background: linear-gradient(90deg, var(--primary-color), var(--primary-dark));
    width: 0%; transition: width .3s ease;
}

/* ── Utilities ── */
.hidden { display: none !important; }
@keyframes spin { from{transform:rotate(0)} to{transform:rotate(360deg)} }

@media (max-width: 700px) {
    .res-toolbar { flex-direction: column; align-items: stretch; }
    .res-toolbar-right { justify-content: space-between; }
    .res-filter-chips { display: none; } /* در موبایل فیلتر داخل accordion */
}
</style>

<!-- ═══════════════════════════════════════════
     JavaScript
═══════════════════════════════════════════ -->
<script>
/* ══════════════════════════════════════════
   ۱. Configuration & State
══════════════════════════════════════════ */

/** رنگ، آیکون، و برچسب هر نوع منبع */
const TYPE_CONFIG = {
    notes:            { label:'جزوه',       icon:'sticky_note_2', color:'var(--type-notes)',  bg:'rgba(0,131,143,.1)'   },
    slides:           { label:'اسلاید',     icon:'slideshow',      color:'var(--type-slides)', bg:'rgba(21,101,192,.1)'  },
    sample_questions: { label:'نمونه‌سؤال', icon:'quiz',           color:'var(--type-sample)', bg:'rgba(229,57,53,.1)'   },
    book:             { label:'کتاب',       icon:'book',           color:'var(--type-book)',   bg:'rgba(109,76,65,.1)'   },
};

/** پسوند فایل → آیکون + رنگ پس‌زمینه */
const FORMAT_ICON = {
    pdf:  { icon:'picture_as_pdf', bg:'rgba(229,57,53,.12)',   color:'#E53935' },
    docx: { icon:'description',    bg:'rgba(21,101,192,.12)',  color:'#1565C0' },
    pptx: { icon:'slideshow',      bg:'rgba(245,124,0,.12)',   color:'#F57C00' },
    zip:  { icon:'folder_zip',     bg:'rgba(109,76,65,.12)',   color:'#6D4C41' },
};

let allResources    = [];   // همه داده‌های خام از API
let courseSuggestions = []; // پیشنهادهای نام درس
let currentView     = 'grid';
let currentTypeFilter = '';
let currentSort     = 'newest';
let searchQuery     = '';
let searchTimer     = null;
let selectedFile    = null;

/* ══════════════════════════════════════════
   ۲. API Functions
══════════════════════════════════════════ */

async function loadResources() {
    showLoading();
    try {
        const params = new URLSearchParams();
        if (searchQuery)       params.set('q', searchQuery);
        if (currentTypeFilter) params.set('type', currentTypeFilter);
        params.set('sort', currentSort);

        const res = await fetch(`/api/resources?${params}`);
        if (!res.ok) throw new Error('خطای سرور');
        allResources = await res.json();
        renderResources();
        updateStats();
    } catch(e) {
        showError('خطا در بارگذاری منابع: ' + e.message);
    }
}

async function loadCourseSuggestions() {
    try {
        const res = await fetch('/api/resources/courses');
        if (res.ok) courseSuggestions = await res.json();
    } catch(e) { /* نادیده بگیر */ }
}

async function submitUpload() {
    const titleVal   = document.getElementById('up-title').value.trim();
    const courseVal  = document.getElementById('up-course').value.trim();
    const typeVal    = document.querySelector('input[name="up-type"]:checked')?.value || 'notes';

    // اعتبارسنجی
    if (!selectedFile) { showToast('لطفاً یک فایل انتخاب کنید', 'error'); return; }
    if (!titleVal)      { showToast('عنوان منبع الزامی است', 'error'); return; }
    if (!courseVal)     { showToast('نام درس الزامی است', 'error'); return; }

    const btn = document.getElementById('upload-submit-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="material-icons spin-anim">sync</i> در حال آپلود...';

    // نمایش progress bar
    const progressWrap = document.getElementById('upload-progress');
    const progressBar  = document.getElementById('upload-progress-bar');
    progressWrap.classList.remove('hidden');

    const formData = new FormData();
    formData.append('file', selectedFile);
    formData.append('title', titleVal);
    formData.append('course_name', courseVal);
    formData.append('resource_type', typeVal);

    try {
        // XHR به جای fetch برای ردیابی پیشرفت آپلود
        await new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/resources');

            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const pct = Math.round(e.loaded / e.total * 100);
                    progressBar.style.width = pct + '%';
                }
            };
            xhr.onload = () => {
                if (xhr.status === 200 || xhr.status === 201) {
                    const data = JSON.parse(xhr.responseText);
                    if (data.status === 'success') resolve(data);
                    else reject(new Error(data.error || 'خطا'));
                } else {
                    try {
                        const d = JSON.parse(xhr.responseText);
                        reject(new Error(d.error || 'خطای سرور'));
                    } catch { reject(new Error('خطای سرور ' + xhr.status)); }
                }
            };
            xhr.onerror = () => reject(new Error('خطای شبکه'));
            xhr.send(formData);
        });

        showToast('فایل با موفقیت آپلود شد ✓', 'success');
        closeUploadModal();
        await loadResources();
        await loadCourseSuggestions();
    } catch(e) {
        showToast('خطا در آپلود: ' + e.message, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="material-icons">cloud_upload</i> آپلود';
        progressWrap.classList.add('hidden');
        progressBar.style.width = '0%';
    }
}

async function likeResource(id, btn) {
    btn.disabled = true;
    try {
        const res = await fetch(`/api/resources/${id}/like`, { method: 'POST' });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'خطا');
        // به‌روزرسانی UI بدون رفرش کامل
        const item = allResources.find(r => r.id === id);
        if (item) {
            item.is_liked    = data.action === 'liked';
            item.like_count  = data.like_count;
        }
        // فقط همان کارت را به‌روز کن
        updateLikeButtonsForId(id, data.action === 'liked', data.like_count);
    } catch(e) {
        showToast('خطا', 'error');
    } finally {
        btn.disabled = false;
    }
}

function updateLikeButtonsForId(id, isLiked, count) {
    // یک منبع ممکن است چند بار در صفحه نمایش داده شود (در بخش‌های مختلف درس)
    document.querySelectorAll(`.like-btn[data-id="${id}"]`).forEach(btn => {
        btn.classList.toggle('liked', isLiked);
        btn.innerHTML = `<i class="material-icons">${isLiked ? 'favorite' : 'favorite_border'}</i> ${count}`;
    });
}

async function deleteResource(id) {
    if (!confirm('آیا این منبع حذف شود؟')) return;
    try {
        const res = await fetch(`/api/resources/${id}`, { method: 'DELETE' });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'خطا');
        showToast('منبع با موفقیت حذف شد', 'success');
        await loadResources();
    } catch(e) {
        showToast('خطا در حذف: ' + e.message, 'error');
    }
}

function downloadResource(id, title) {
    // شمارشگر دانلود در سرور به‌روز می‌شود
    window.location.href = `/api/resources/${id}/download`;
    // به‌روزرسانی محلی شمارشگر
    const item = allResources.find(r => r.id === id);
    if (item) {
        item.download_count++;
        document.querySelectorAll(`.dl-count[data-id="${id}"]`).forEach(el => {
            el.textContent = item.download_count;
        });
    }
}

/* ══════════════════════════════════════════
   ۳. Rendering
══════════════════════════════════════════ */

function renderResources() {
    const container = document.getElementById('resources-container');

    if (allResources.length === 0) {
        container.innerHTML = `
            <div class="empty-res-state">
                <i class="material-icons">library_books</i>
                <h3>منبعی پیدا نشد</h3>
                <p>${searchQuery ? 'نتیجه‌ای برای جستجوی شما یافت نشد' : 'اولین نفری باشید که منبع درسی اضافه می‌کند!'}</p>
            </div>`;
        return;
    }

    // گروه‌بندی بر اساس نام درس
    const grouped = {};
    allResources.forEach(r => {
        if (!grouped[r.course_name]) grouped[r.course_name] = [];
        grouped[r.course_name].push(r);
    });

    const courseNames = Object.keys(grouped).sort();
    let html = '';
    courseNames.forEach((course, idx) => {
        const items = grouped[course];
        html += buildCourseSection(course, items, idx === 0);
    });
    container.innerHTML = html;
}

function buildCourseSection(courseName, items, isOpen) {
    const bodyItems = currentView === 'grid'
        ? `<div class="res-grid">${items.map(buildGridCard).join('')}</div>`
        : `<div class="res-list">${items.map(buildListRow).join('')}</div>`;

    return `
    <div class="course-section">
        <div class="course-section-header ${isOpen ? 'open' : ''}"
             onclick="toggleCourse(this)">
            <i class="material-icons course-icon">class</i>
            <span class="course-name">${escHtml(courseName)}</span>
            <span class="course-count">${items.length} منبع</span>
            <i class="material-icons course-toggle-icon">chevron_left</i>
        </div>
        <div class="course-body ${isOpen ? 'open' : ''}">
            ${bodyItems}
        </div>
    </div>`;
}

function buildGridCard(r) {
    const tc  = TYPE_CONFIG[r.resource_type] || TYPE_CONFIG.notes;
    const fc  = FORMAT_ICON[r.file_format]   || FORMAT_ICON.pdf;
    const uploaderInitial = r.uploader_name ? r.uploader_name[0] : '?';

    return `
    <div class="res-card" style="--card-type-color:${tc.color}">
        <div class="res-card-top">
            <div class="res-card-file-icon" style="background:${fc.bg}">
                <i class="material-icons" style="color:${fc.color}">${fc.icon}</i>
            </div>
            <div class="res-card-meta">
                <div class="res-card-title" title="${escHtml(r.title)}">${escHtml(r.title)}</div>
                <span class="type-badge" style="background:${tc.bg};color:${tc.color}">
                    <i class="material-icons" style="font-size:.75rem">${tc.icon}</i>
                    ${tc.label}
                </span>
            </div>
        </div>

        <hr class="res-card-divider">

        <div class="res-card-info">
            <div class="res-card-info-item">
                <i class="material-icons">data_usage</i> ${r.file_size_str}
            </div>
            <div class="res-card-info-item">
                <i class="material-icons">file_present</i> ${r.file_format.toUpperCase()}
            </div>
            <div class="res-card-info-item">
                <i class="material-icons">download</i> ${r.download_count} دانلود
            </div>
            <div class="res-card-info-item">
                <i class="material-icons">calendar_today</i> ${r.upload_date_j}
            </div>
        </div>

        <div class="res-card-footer">
            <div class="res-card-uploader">
                <div class="uploader-avatar">${uploaderInitial}</div>
                <span>${escHtml(r.uploader_name)}</span>
            </div>
            <div class="res-card-actions">
                <button class="res-action-btn like-btn ${r.is_liked ? 'liked' : ''}"
                        data-id="${r.id}"
                        onclick="likeResource(${r.id}, this)">
                    <i class="material-icons">${r.is_liked ? 'favorite' : 'favorite_border'}</i>
                    ${r.like_count}
                </button>
                <button class="res-action-btn download-btn"
                        onclick="downloadResource(${r.id}, '${escJs(r.title)}')">
                    <i class="material-icons">download</i>
                </button>
                ${r.can_delete ? `
                <button class="res-action-btn delete-btn" onclick="deleteResource(${r.id})">
                    <i class="material-icons">delete_outline</i>
                </button>` : ''}
            </div>
        </div>
    </div>`;
}

function buildListRow(r) {
    const tc  = TYPE_CONFIG[r.resource_type] || TYPE_CONFIG.notes;
    const fc  = FORMAT_ICON[r.file_format]   || FORMAT_ICON.pdf;
    const uploaderInitial = r.uploader_name ? r.uploader_name[0] : '?';

    return `
    <div class="res-row">
        <div class="res-row-icon" style="background:${fc.bg}">
            <i class="material-icons" style="color:${fc.color}">${fc.icon}</i>
        </div>
        <div class="res-row-info">
            <div class="res-row-title" title="${escHtml(r.title)}">${escHtml(r.title)}</div>
            <div class="res-row-meta">
                <span class="type-badge" style="background:${tc.bg};color:${tc.color}">
                    <i class="material-icons" style="font-size:.72rem">${tc.icon}</i>
                    ${tc.label}
                </span>
                <span class="res-row-meta-item">
                    <i class="material-icons">data_usage</i> ${r.file_size_str}
                </span>
                <span class="res-row-meta-item">
                    <i class="material-icons">download</i>
                    <span class="dl-count" data-id="${r.id}">${r.download_count}</span> دانلود
                </span>
                <span class="res-row-meta-item">
                    <div class="uploader-avatar">${uploaderInitial}</div>
                    ${escHtml(r.uploader_name)}
                </span>
                <span class="res-row-meta-item">
                    <i class="material-icons">calendar_today</i> ${r.upload_date_j}
                </span>
            </div>
        </div>
        <div class="res-row-actions">
            <button class="res-action-btn like-btn ${r.is_liked ? 'liked' : ''}"
                    data-id="${r.id}"
                    onclick="likeResource(${r.id}, this)">
                <i class="material-icons">${r.is_liked ? 'favorite' : 'favorite_border'}</i>
                ${r.like_count}
            </button>
            <button class="res-action-btn download-btn"
                    onclick="downloadResource(${r.id}, '${escJs(r.title)}')">
                <i class="material-icons">download</i>
                <span>دانلود</span>
            </button>
            ${r.can_delete ? `
            <button class="res-action-btn delete-btn" onclick="deleteResource(${r.id})">
                <i class="material-icons">delete_outline</i>
            </button>` : ''}
        </div>
    </div>`;
}

function showLoading() {
    document.getElementById('resources-container').innerHTML = `
        <div class="loading-state-res">
            <i class="material-icons spin-anim">sync</i>
            <span>در حال بارگذاری...</span>
        </div>`;
}

function showError(msg) {
    document.getElementById('resources-container').innerHTML = `
        <div class="empty-res-state">
            <i class="material-icons" style="color:var(--error)">error_outline</i>
            <h3>خطا در بارگذاری</h3>
            <p>${escHtml(msg)}</p>
            <button class="btn btn-outline" style="margin-top:1rem;" onclick="loadResources()">
                <i class="material-icons">refresh</i> تلاش مجدد
            </button>
        </div>`;
}

function updateStats() {
    const total   = allResources.length;
    const courses = new Set(allResources.map(r => r.course_name)).size;
    document.getElementById('stats-total').innerHTML =
        `<i class="material-icons">folder</i> ${total} منبع در ${courses} درس`;
}

/* ══════════════════════════════════════════
   ۴. Filter & Sort Logic
══════════════════════════════════════════ */

function applyFiltersAndRender() {
    currentSort = document.getElementById('sort-select').value;
    loadResources();
}

function setTypeFilter(type, btn) {
    currentTypeFilter = type;
    document.querySelectorAll('.res-chip').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    loadResources();
}

function debounceSearch() {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => {
        searchQuery = document.getElementById('res-search-input').value.trim();
        document.getElementById('search-clear-btn').classList.toggle('hidden', !searchQuery);
        loadResources();
    }, 380);
}

function clearSearch() {
    document.getElementById('res-search-input').value = '';
    searchQuery = '';
    document.getElementById('search-clear-btn').classList.add('hidden');
    loadResources();
}

/* ══════════════════════════════════════════
   ۵. View Toggle
══════════════════════════════════════════ */

function setView(view) {
    currentView = view;
    document.getElementById('view-grid-btn').classList.toggle('active', view === 'grid');
    document.getElementById('view-list-btn').classList.toggle('active', view === 'list');
    renderResources();  // فقط رندر مجدد — بدون درخواست API
}

/* ══════════════════════════════════════════
   ۶. Course Section Toggle
══════════════════════════════════════════ */

function toggleCourse(header) {
    header.classList.toggle('open');
    const body = header.nextElementSibling;
    body.classList.toggle('open');
}

/* ══════════════════════════════════════════
   ۷. Upload Modal
══════════════════════════════════════════ */

function openUploadModal() {
    // ریست فرم
    selectedFile = null;
    document.getElementById('up-title').value  = '';
    document.getElementById('up-course').value = '';
    document.getElementById('file-input').value = '';
    document.querySelector('input[name="up-type"][value="notes"]').checked = true;
    document.getElementById('dropzone').classList.remove('has-file');
    document.getElementById('dropzone-content').classList.remove('hidden');
    document.getElementById('dropzone-selected').classList.add('hidden');
    document.getElementById('upload-progress').classList.add('hidden');
    document.getElementById('upload-progress-bar').style.width = '0%';
    document.getElementById('course-suggestions').classList.add('hidden');
    document.getElementById('upload-modal').classList.add('open');
}

function closeUploadModal() {
    document.getElementById('upload-modal').classList.remove('open');
}

/* ── File Handling ── */

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) setSelectedFile(file);
}

function handleDragOver(event) {
    event.preventDefault();
    event.currentTarget.classList.add('drag-over');
}

function handleDragLeave(event) {
    event.currentTarget.classList.remove('drag-over');
}

function handleDrop(event) {
    event.preventDefault();
    event.currentTarget.classList.remove('drag-over');
    const file = event.dataTransfer.files[0];
    if (file) setSelectedFile(file);
}

function setSelectedFile(file) {
    const allowedExts = ['pdf','docx','pptx','zip'];
    const ext = file.name.split('.').pop().toLowerCase();
    if (!allowedExts.includes(ext)) {
        showToast('فرمت فایل مجاز نیست. از PDF، DOCX، PPTX یا ZIP استفاده کنید.', 'error');
        return;
    }
    if (file.size > 50 * 1024 * 1024) {
        showToast('حجم فایل نباید بیش از ۵۰ مگابایت باشد', 'error');
        return;
    }
    selectedFile = file;

    // آیکون بر اساس پسوند
    const fc = FORMAT_ICON[ext] || FORMAT_ICON.pdf;
    const iconEl = document.getElementById('file-preview-icon');
    iconEl.innerHTML = `<i class="material-icons" style="font-size:1.6rem;color:${fc.color}">${fc.icon}</i>`;
    iconEl.style.background = fc.bg;

    document.getElementById('file-preview-name').textContent = file.name;
    document.getElementById('file-preview-size').textContent = formatBytes(file.size);

    const dropzone = document.getElementById('dropzone');
    dropzone.classList.add('has-file');
    document.getElementById('dropzone-content').classList.add('hidden');
    document.getElementById('dropzone-selected').classList.remove('hidden');

    // پیش‌پر کردن عنوان اگر خالی باشد
    const titleInput = document.getElementById('up-title');
    if (!titleInput.value.trim()) {
        titleInput.value = file.name.replace(/\.[^.]+$/, ''); // حذف پسوند
    }
}

function clearFileSelection(event) {
    event.stopPropagation();
    selectedFile = null;
    document.getElementById('file-input').value = '';
    document.getElementById('dropzone').classList.remove('has-file');
    document.getElementById('dropzone-content').classList.remove('hidden');
    document.getElementById('dropzone-selected').classList.add('hidden');
}

/* ── Course Suggestions ── */

function showCourseSuggestions() {
    const val  = document.getElementById('up-course').value.trim().toLowerCase();
    const wrap = document.getElementById('course-suggestions');
    if (!val || courseSuggestions.length === 0) { wrap.classList.add('hidden'); return; }
    const matches = courseSuggestions.filter(c => c.toLowerCase().includes(val)).slice(0, 6);
    if (matches.length === 0) { wrap.classList.add('hidden'); return; }
    wrap.innerHTML = matches.map(c => `
        <div class="course-suggestion-item" onclick="selectCourse('${escJs(c)}')">
            <i class="material-icons">menu_book</i> ${escHtml(c)}
        </div>`).join('');
    wrap.classList.remove('hidden');
}

function selectCourse(name) {
    document.getElementById('up-course').value = name;
    document.getElementById('course-suggestions').classList.add('hidden');
}

// کلیک خارج از suggestions → بستن
document.addEventListener('click', (e) => {
    if (!e.target.closest('.course-input-wrap')) {
        document.getElementById('course-suggestions')?.classList.add('hidden');
    }
});

/* ══════════════════════════════════════════
   ۸. Utilities
══════════════════════════════════════════ */

function formatBytes(bytes) {
    if (bytes < 1024)           return `${bytes} B`;
    if (bytes < 1024 * 1024)    return `${(bytes/1024).toFixed(1)} KB`;
    return `${(bytes/(1024*1024)).toFixed(1)} MB`;
}

function escHtml(str) {
    return String(str)
        .replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function escJs(str) {
    return String(str).replace(/\\/g,'\\\\').replace(/'/g,"\\'");
}

function showToast(msg, type='success') {
    document.getElementById('res-toast')?.remove();
    const t = document.createElement('div');
    t.id = 'res-toast';
    const bg = type === 'success'
        ? 'linear-gradient(135deg,var(--success),#1b5e20)'
        : 'linear-gradient(135deg,var(--error),#b71c1c)';
    t.style.cssText = `
        position:fixed; bottom:1.5rem; left:50%; transform:translateX(-50%);
        background:${bg}; color:white; padding:.8rem 1.75rem; border-radius:24px;
        font-size:.9rem; font-weight:600; z-index:9999;
        box-shadow:0 6px 20px rgba(0,0,0,.25);
        display:flex; align-items:center; gap:.5rem;
        animation:modalIn .25s ease; font-family:inherit; white-space:nowrap;
    `;
    t.innerHTML = `<i class="material-icons" style="font-size:1.1rem">${type==='success'?'check_circle':'error'}</i>${msg}`;
    document.body.appendChild(t);
    setTimeout(() => {
        t.style.transition = 'opacity .3s';
        t.style.opacity = '0';
        setTimeout(() => t.remove(), 300);
    }, 3500);
}

/* ══════════════════════════════════════════
   ۹. Init
══════════════════════════════════════════ */

document.addEventListener('DOMContentLoaded', () => {
    loadResources();
    loadCourseSuggestions();
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') closeUploadModal();
    });
});
</script>
{% endblock %}