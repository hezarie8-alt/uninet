{% extends "base.html" %}

{% block title %}Ù¾ÛŒØ§Ù…â€ŒØ±Ø³Ø§Ù† | ÛŒÙˆÙ†ÛŒ Ù†Øª{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- Sidebar -->
    <aside class="chat-sidebar" id="chat-sidebar">
        <div class="sidebar-header">
            <h2>Ù¾ÛŒØ§Ù…â€ŒØ±Ø³Ø§Ù†</h2>
        </div>
        
        <!-- Tabs for Group/Channel/Private -->
        <div class="chat-modes">
            <div class="mode-tab active" onclick="switchChatMode('private')">Ø®ØµÙˆØµÛŒ</div>
            <div class="mode-tab" onclick="switchChatMode('group')">Ú¯Ø±ÙˆÙ‡</div>
            <div class="mode-tab" onclick="switchChatMode('channel')">Ú©Ø§Ù†Ø§Ù„</div>
        </div>

        <!-- Dynamic Content Area -->
        <div id="sidebar-content">
            <!-- Private List (Default) -->
            <div id="private-list" class="list-container active">
                <div class="search-box">
                    <input type="text" placeholder="Ø¬Ø³ØªØ¬Ùˆ..." disabled>
                </div>
                <div class="conversation-list" id="convos">
                    <!-- Filled by JS -->
                </div>
            </div>
            
            <!-- Group Members List -->
            <div id="group-list" class="list-container">
                <h4 style="padding: 0 1rem; color: var(--text-secondary);">Ø§Ø¹Ø¶Ø§ÛŒ Ú¯Ø±ÙˆÙ‡</h4>
                <div class="member-list" id="members">
                    <!-- Filled by JS -->
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Chat Area -->
    <main class="chat-main">
        <!-- Private Chat View -->
        <div id="view-private" class="chat-view active">
            <div class="chat-header" id="private-header">
                <button class="btn-icon" onclick="toggleSidebar()"><i class="material-icons">menu</i></button>
                <div class="user-info-header">
                    <img src="" id="private-avatar" class="avatar-small">
                    <div>
                        <h3 id="private-name">Ú©Ø§Ø±Ø¨Ø±</h3>
                        <span id="private-status">Ø¢Ù†Ù„Ø§ÛŒÙ†</span>
                    </div>
                </div>
                <a href="#" id="private-profile-link" class="btn-icon"><i class="material-icons">person</i></a>
            </div>
            <div class="chat-messages" id="private-msgs"></div>
            <div class="chat-input-box">
                <label class="attach-btn"><i class="material-icons">attach_file</i><input type="file" style="display:none" onchange="uploadFile(this, 'private')"></label>
                <input type="text" id="private-input" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...">
                <button class="send-btn" onclick="sendPrivateMessage()"><i class="material-icons">send</i></button>
            </div>
        </div>

        <!-- Group Chat View -->
        <div id="view-group" class="chat-view">
            <div class="chat-header">
                <button class="btn-icon" onclick="toggleSidebar()"><i class="material-icons">menu</i></button>
                <div class="user-info-header">
                    <div class="avatar-small icon-avatar"><i class="material-icons">groups</i></div>
                    <div>
                        <h3>Ú¯Ø±ÙˆÙ‡ Ø¹Ù…ÙˆÙ…ÛŒ</h3>
                        <span>Ú¯ÙØªÚ¯ÙˆÛŒ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†</span>
                    </div>
                </div>
            </div>
            <div class="chat-messages" id="group-msgs"></div>
            <div class="chat-input-box">
                <label class="attach-btn"><i class="material-icons">attach_file</i><input type="file" style="display:none" onchange="uploadFile(this, 'group')"></label>
                <input type="text" id="group-input" placeholder="Ù¾ÛŒØ§Ù… Ø¯Ø± Ú¯Ø±ÙˆÙ‡...">
                <button class="send-btn" onclick="sendGroupMessage()"><i class="material-icons">send</i></button>
            </div>
        </div>

        <!-- Channel View -->
        <div id="view-channel" class="chat-view">
            <div class="chat-header">
                <button class="btn-icon" onclick="toggleSidebar()"><i class="material-icons">menu</i></button>
                <div class="user-info-header">
                    <div class="avatar-small icon-avatar"><i class="material-icons">campaign</i></div>
                    <div>
                        <h3>Ú©Ø§Ù†Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹ÛŒÙ‡â€ŒÙ‡Ø§</h3>
                        <span>Ù…Ø¯ÛŒØ±ÛŒØª</span>
                    </div>
                </div>
            </div>
            <div class="chat-messages" id="channel-msgs"></div>
            
            {% if is_admin %}
            <div class="chat-input-box">
                <label class="attach-btn"><i class="material-icons">attach_file</i><input type="file" style="display:none" onchange="uploadFile(this, 'channel')"></label>
                <input type="text" id="channel-input" placeholder="Ø§Ø·Ù„Ø§Ø¹ÛŒÙ‡ Ø¬Ø¯ÛŒØ¯...">
                <button class="send-btn" onclick="sendChannelMessage()"><i class="material-icons">send</i></button>
            </div>
            {% else %}
            <div class="chat-input-box disabled"><span>ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù¾ÛŒØ§Ù… Ø§Ø±Ø³Ø§Ù„ Ú©Ù†Ø¯</span></div>
            {% endif %}
        </div>
    </main>
</div>

<style>
    .chat-container { display: flex; height: calc(100vh - 60px); background: var(--background); }
    
    /* Sidebar */
    .chat-sidebar { width: 300px; background: var(--surface); border-left: 1px solid var(--border-color); display: flex; flex-direction: column; }
    .sidebar-header { padding: 1rem; border-bottom: 1px solid var(--border-color); }
    .chat-modes { display: flex; border-bottom: 1px solid var(--border-color); }
    .mode-tab { flex: 1; padding: 0.75rem; text-align: center; cursor: pointer; color: var(--text-secondary); font-size: 0.9rem; font-weight: 600; border-bottom: 2px solid transparent; }
    .mode-tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); background: rgba(0,131,143,0.05); }
    .list-container { display: none; flex: 1; overflow-y: auto; padding-top: 0.5rem; }
    .list-container.active { display: block; }
    
    /* Items */
    .convo-item { display: flex; align-items: center; padding: 0.75rem 1rem; gap: 0.75rem; cursor: pointer; transition: background 0.2s; border-bottom: 1px solid var(--border-color); }
    .convo-item:hover, .member-item:hover { background: var(--background); }
    .convo-item.active { background: var(--primary-light); color: white; }
    .member-item { display: flex; align-items: center; padding: 0.75rem 1rem; gap: 0.75rem; }
    .avatar-small { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; }
    .item-info h4 { margin: 0; font-size: 0.95rem; }
    .item-info p { margin: 0; font-size: 0.8rem; color: var(--text-secondary); }
    .online-dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; margin-right: auto; }

    /* Main */
    .chat-main { flex: 1; display: flex; flex-direction: column; position: relative; }
    .chat-view { display: none; flex-direction: column; height: 100%; }
    .chat-view.active { display: flex; }
    
    .chat-header { display: flex; align-items: center; padding: 0.75rem 1rem; background: var(--surface); border-bottom: 1px solid var(--border-color); gap: 1rem; }
    .user-info-header { display: flex; align-items: center; gap: 0.75rem; flex: 1; }
    .user-info-header h3 { margin: 0; font-size: 1rem; }
    .user-info-header span { font-size: 0.8rem; color: var(--text-secondary); }
    
    .chat-messages { flex: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 0.75rem; background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%239C92AC' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v-2h4v4h2v-4h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4v-2H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); }

    /* Messages */
    .msg { max-width: 70%; padding: 0.75rem 1rem; border-radius: 12px; position: relative; word-wrap: break-word; }
    .msg.sent { background: var(--primary-color); color: white; align-self: flex-end; border-bottom-left-radius: 4px; }
    .msg.received { background: var(--surface); align-self: flex-start; border-bottom-right-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .msg-sender { font-size: 0.75rem; font-weight: 700; color: var(--primary-color); margin-bottom: 0.25rem; display: block; cursor: pointer; }
    .msg-time { font-size: 0.7rem; opacity: 0.7; margin-top: 0.25rem; text-align: left; }
    .msg-file { display: block; margin-top: 0.5rem; font-size: 0.85rem; background: rgba(0,0,0,0.1); padding: 0.25rem 0.5rem; border-radius: 4px; }

    /* Input */
    .chat-input-box { background: var(--surface); padding: 0.75rem; display: flex; gap: 0.5rem; border-top: 1px solid var(--border-color); align-items: center; }
    .chat-input-box input { flex: 1; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 24px; outline: none; font-family: inherit; background: var(--background); }
    .chat-input-box input:focus { border-color: var(--primary-color); }
    .send-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--primary-color); color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .attach-btn { color: var(--text-secondary); cursor: pointer; padding: 0.5rem; }
    .attach-btn:hover { color: var(--primary-color); }
    .disabled { background: var(--surface); padding: 1rem; text-align: center; color: var(--text-secondary); }

    @media (max-width: 768px) {
        .chat-sidebar { position: absolute; right: 0; width: 100%; height: 100%; z-index: 100; display: none; }
        .chat-sidebar.active { display: flex; }
    }
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    const socket = io();
    const currentUserId = {{ current_user.id if current_user else 'null' }};
    
    // Data Injection
    const initialMessages = {% if messages %}{{ messages | tojson }}{% else %}[]{% endif %};
    const groupMessages = {% if group_messages %}{{ group_messages | tojson }}{% else %}[]{% endif %};
    const channelMessages = {% if channel_messages %}{{ channel_messages | tojson }}{% else %}[]{% endif %};
    
    let activePrivateUser = {% if active_chat_user %}{{ active_chat_user.id }}{% else %}null{% endif %};
    let activeMode = 'private'; // private, group, channel

    // --- Socket Events ---
    socket.on('connect', () => {
        console.log("Connected");
        if(activePrivateUser) socket.emit('join_chat', {other_user_id: activePrivateUser});
        loadGroupMembers();
    });

    socket.on('new_message', data => {
        if (activeMode === 'private' && (data.sender_id === activePrivateUser || data.sender_id === currentUserId)) {
            appendMessage('private-msgs', data, 'received', data.sender_id === currentUserId);
        }
    });

    socket.on('new_group_message', data => {
        if (activeMode === 'group') {
            appendMessage('group-msgs', data, 'received', data.sender_id === currentUserId);
        }
    });

    socket.on('new_channel_message', data => {
        if (activeMode === 'channel') {
            appendMessage('channel-msgs', data, 'received', false); // always received style for users
        }
    });

    // --- Logic ---
    function switchChatMode(mode) {
        activeMode = mode;
        
        // UI Updates
        document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        
        document.querySelectorAll('.list-container').forEach(c => c.classList.remove('active'));
        document.getElementById(mode + '-list').classList.add('active');
        
        document.querySelectorAll('.chat-view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-' + mode).classList.add('active');
        
        // Load Data
        if (mode === 'private') loadPrivateHistory();
        else if (mode === 'group') loadGroupHistory();
        else if (mode === 'channel') loadChannelHistory();
    }

    function loadPrivateHistory() {
        const container = document.getElementById('private-msgs');
        container.innerHTML = '';
        initialMessages.forEach(m => appendMessage('private-msgs', m, 'received', m.sender_id === currentUserId));
    }

    function loadGroupHistory() {
        const container = document.getElementById('group-msgs');
        container.innerHTML = '';
        groupMessages.forEach(m => appendMessage('group-msgs', m, 'received', m.sender_id === currentUserId));
    }

    function loadChannelHistory() {
        const container = document.getElementById('channel-msgs');
        container.innerHTML = '';
        channelMessages.forEach(m => appendMessage('channel-msgs', m, 'received', false));
    }

    function loadGroupMembers() {
        fetch('/api/group_members')
            .then(res => res.json())
            .then(data => {
                const container = document.getElementById('members');
                container.innerHTML = '';
                if (data.length === 0) {
                    container.innerHTML = '<p style="text-align:center; padding:1rem; color:var(--text-secondary);">Ø¹Ø¶ÙˆÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>';
                    return;
                }
                data.forEach(u => {
                    const div = document.createElement('div');
                    div.className = 'member-item';
                    div.innerHTML = `
                        <div class="avatar-small">${u.name[0]}</div>
                        <div class="item-info" style="flex:1">
                            <h4>${u.name}</h4>
                        </div>
                        ${u.online ? '<div class="online-dot"></div>' : ''}
                        <a href="/profile/${u.id}" class="btn-icon"><i class="material-icons">person</i></a>
                    `;
                    container.appendChild(div);
                });
            });
    }

    function appendMessage(containerId, data, defaultType, isSent) {
        const container = document.getElementById(containerId);
        const div = document.createElement('div');
        const type = isSent ? 'sent' : defaultType;
        
        // Handle sender name for group
        let senderHtml = '';
        if (type === 'received' && data.sender_name && containerId === 'group-msgs') {
            senderHtml = `<span class="msg-sender" onclick="window.location.href='/profile/${data.sender_id}'">${data.sender_name}</span>`;
        }

        const time = data.timestamp || new Date().toLocaleTimeString('fa-IR', {hour:'2-digit', minute:'2-digit'});
        const fileHtml = data.file_path ? `<a class="msg-file" href="${data.file_path}" target="_blank">ğŸ“ ÙØ§ÛŒÙ„</a>` : '';
        
        div.className = `msg ${type}`;
        div.innerHTML = `${senderHtml}${data.content || ''}${fileHtml}<div class="msg-time">${time}</div>`;
        
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    // --- Actions ---
    function sendPrivateMessage() {
        const input = document.getElementById('private-input');
        const content = input.value.trim();
        if (!content || !activePrivateUser) return;
        
        socket.emit('send_message', {content: content, other_user_id: activePrivateUser});
        input.value = '';
        // Optimistic UI handled by socket event
    }

    function sendGroupMessage() {
        const input = document.getElementById('group-input');
        const content = input.value.trim();
        if (!content) return;
        
        socket.emit('send_group_message', {content: content});
        input.value = '';
    }

    function sendChannelMessage() {
        const input = document.getElementById('channel-input');
        const content = input.value.trim();
        if (!content) return;
        
        socket.emit('send_channel_message', {content: content});
        input.value = '';
    }

    function uploadFile(inputElement, type) {
        const file = inputElement.files[0];
        if (!file) return;
        
        const formData = new FormData();
        formData.append('file', file);
        
        fetch('/upload_chat_file', { method: 'POST', body: formData })
        .then(res => res.json())
        .then(data => {
            if (data.filepath) {
                if (type === 'private') socket.emit('send_message', {content: 'ÙØ§ÛŒÙ„', file_path: data.filepath, other_user_id: activePrivateUser});
                else if (type === 'group') socket.emit('send_group_message', {content: 'ÙØ§ÛŒÙ„', file_path: data.filepath});
                else if (type === 'channel') socket.emit('send_channel_message', {content: 'ÙØ§ÛŒÙ„', file_path: data.filepath});
            }
        });
        inputElement.value = '';
    }

    function toggleSidebar() {
        document.getElementById('chat-sidebar').classList.toggle('active');
    }

    // --- Initialization ---
    // If we have an active chat user, setup the header
    {% if active_chat_user %}
        document.getElementById('private-name').innerText = "{{ active_chat_user.full_name }}";
        document.getElementById('private-status').innerText = "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...";
        document.getElementById('private-profile-link').href = "/profile/{{ active_chat_user.id }}";
        // Load history already handled by HTML injection
    {% endif %}

    // Enter Key Listeners
    document.getElementById('private-input').addEventListener('keypress', e => { if(e.key === 'Enter') sendPrivateMessage(); });
    document.getElementById('group-input').addEventListener('keypress', e => { if(e.key === 'Enter') sendGroupMessage(); });
    document.getElementById('channel-input').addEventListener('keypress', e => { if(e.key === 'Enter') sendChannelMessage(); });

</script>
{% endblock %}