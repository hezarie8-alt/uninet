{% extends "base.html" %}

{% block title %}ورود و ثبت‌نام | یونی نت{% endblock %}

{#
  مشکل ۸: این flag به base.html می‌گوید که در این صفحه
  فوتر (قسمت درباره ما، ارتباط با ما و...) نشان داده نشود.
  در base.html باید شرط {% if not hide_footer %} اضافه شود.
#}
{% set hide_footer = true %}

{% block content %}
<div class="auth-container">

    <div class="auth-header">
        <div class="auth-logo">
            <i class="material-icons">school</i>
        </div>
        <h1 class="auth-title">به یونی نت خوش آمدید</h1>
        <p class="auth-subtitle">پلتفرم یکپارچه دانشجویی</p>
    </div>

    <!-- نمایش پیام‌های flash از سرور -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="auth-alert auth-alert-{{ category }}">
                <i class="material-icons">
                    {% if category == 'success' %}check_circle
                    {% elif category == 'error' %}error
                    {% else %}info{% endif %}
                </i>
                <span>{{ message }}</span>
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- تب‌های انتخاب فرم -->
    <div class="auth-tabs">
        <div class="auth-tab active" id="tab-btn-register"
             onclick="switchTab('register', this)">
            <i class="material-icons">person_add</i>
            <span>ثبت‌نام</span>
        </div>
        <div class="auth-tab" id="tab-btn-login"
             onclick="switchTab('login', this)">
            <i class="material-icons">login</i>
            <span>ورود</span>
        </div>
    </div>

    <!-- ===== فرم ثبت‌نام ===== -->
    <div id="register-tab" class="auth-tab-content active">
        <div class="auth-form-card">
            <h2 class="form-section-title">
                <i class="material-icons">how_to_reg</i>
                ایجاد حساب کاربری
            </h2>

            <!-- خلاصه خطاهای client-side -->
            <div class="validation-summary" id="reg-validation-summary"
                 style="display:none;" role="alert" aria-live="polite">
                <div class="validation-summary-header">
                    <i class="material-icons">warning_amber</i>
                    <strong>لطفاً موارد زیر را تکمیل کنید:</strong>
                </div>
                <ul class="validation-summary-list" id="reg-validation-list"></ul>
            </div>

            <form method="POST" action="{{ url_for('register') }}" novalidate
                  id="register-form" onsubmit="return validateRegisterForm(event)">
                {{ form.hidden_tag() }}

                <!-- نام و نام خانوادگی -->
                <div class="form-group">
                    {{ form.full_name.label(class="form-label") }}
                    {{ form.full_name(
                        class="form-control" + (" input-error" if form.full_name.errors else ""),
                        placeholder="نام و نام خانوادگی",
                        id="reg-full-name",
                        autocomplete="name"
                    ) }}
                    {% if form.full_name.errors %}
                        <div class="field-error" id="err-full-name">
                            <i class="material-icons">error_outline</i>
                            {{ form.full_name.errors[0] }}
                        </div>
                    {% else %}
                        <div class="field-error" id="err-full-name" style="display:none;">
                            <i class="material-icons">error_outline</i>
                            <span></span>
                        </div>
                    {% endif %}
                </div>

                <!-- شماره دانشجویی -->
                <div class="form-group">
                    {{ form.student_id.label(class="form-label") }}
                    {{ form.student_id(
                        class="form-control" + (" input-error" if form.student_id.errors else ""),
                        placeholder="۱۰ رقم (بدون خط تیره)",
                        maxlength="10",
                        inputmode="numeric",
                        id="reg-student-id",
                        autocomplete="username"
                    ) }}
                    {% if form.student_id.errors %}
                        <div class="field-error" id="err-student-id">
                            <i class="material-icons">error_outline</i>
                            {{ form.student_id.errors[0] }}
                        </div>
                    {% else %}
                        <div class="field-error" id="err-student-id" style="display:none;">
                            <i class="material-icons">error_outline</i>
                            <span></span>
                        </div>
                    {% endif %}
                    <div class="field-hint">
                        <i class="material-icons">info_outline</i>
                        شماره دانشجویی شناسه یکتای شما در سیستم است.
                    </div>
                </div>

                <!-- رشته تحصیلی -->
                <div class="form-group">
                    {{ form.major.label(class="form-label") }}
                    {{ form.major(
                        class="form-select" + (" input-error" if form.major.errors else ""),
                        id="reg-major"
                    ) }}
                    {% if form.major.errors %}
                        <div class="field-error" id="err-major">
                            <i class="material-icons">error_outline</i>
                            {{ form.major.errors[0] }}
                        </div>
                    {% else %}
                        <div class="field-error" id="err-major" style="display:none;">
                            <i class="material-icons">error_outline</i>
                            <span></span>
                        </div>
                    {% endif %}
                </div>

                <!-- رمز عبور (کد ملی) — بدون نشانگر قدرت -->
                <div class="form-group">
                    {{ form.password.label(class="form-label") }}
                    <div class="input-with-toggle">
                        {{ form.password(
                            class="form-control" + (" input-error" if form.password.errors else ""),
                            placeholder="کد ملی (۱۰ رقم)",
                            maxlength="10",
                            inputmode="numeric",
                            id="reg-password",
                            autocomplete="new-password"
                        ) }}
                        <button type="button" class="toggle-password-btn"
                                onclick="togglePassword('reg-password', this)"
                                tabindex="-1" title="نمایش/مخفی کردن رمز">
                            <i class="material-icons">visibility</i>
                        </button>
                    </div>
                    {% if form.password.errors %}
                        <div class="field-error" id="err-password">
                            <i class="material-icons">error_outline</i>
                            {{ form.password.errors[0] }}
                        </div>
                    {% else %}
                        <div class="field-error" id="err-password" style="display:none;">
                            <i class="material-icons">error_outline</i>
                            <span></span>
                        </div>
                    {% endif %}
                    {#
                      نشانگر قدرت رمز عبور حذف شد —
                      چون رمز در این سیستم همیشه کد ملی (۱۰ رقم ثابت) است
                      و نشان دادن سطح قدرت معنایی ندارد.
                    #}
                </div>

                <!-- تکرار رمز عبور -->
                <div class="form-group">
                    {{ form.confirm_password.label(class="form-label") }}
                    <div class="input-with-toggle">
                        {{ form.confirm_password(
                            class="form-control" + (" input-error" if form.confirm_password.errors else ""),
                            placeholder="تکرار کد ملی",
                            maxlength="10",
                            inputmode="numeric",
                            id="reg-confirm-password",
                            autocomplete="new-password"
                        ) }}
                        <button type="button" class="toggle-password-btn"
                                onclick="togglePassword('reg-confirm-password', this)"
                                tabindex="-1" title="نمایش/مخفی کردن رمز">
                            <i class="material-icons">visibility</i>
                        </button>
                    </div>
                    {% if form.confirm_password.errors %}
                        <div class="field-error" id="err-confirm-password">
                            <i class="material-icons">error_outline</i>
                            {{ form.confirm_password.errors[0] }}
                        </div>
                    {% else %}
                        <div class="field-error" id="err-confirm-password" style="display:none;">
                            <i class="material-icons">error_outline</i>
                            <span></span>
                        </div>
                    {% endif %}
                </div>

                <button type="submit" class="btn btn-custom auth-submit-btn" id="reg-submit-btn">
                    <i class="material-icons">person_add</i>
                    ایجاد حساب کاربری
                </button>
            </form>

            <p class="auth-switch-hint">
                قبلاً ثبت‌نام کرده‌اید؟
                <a href="#" onclick="switchTab('login', document.getElementById('tab-btn-login')); return false;">
                    وارد شوید
                </a>
            </p>
        </div>
    </div>

    <!-- ===== فرم ورود ===== -->
    <div id="login-tab" class="auth-tab-content">
        <div class="auth-form-card">
            <h2 class="form-section-title">
                <i class="material-icons">login</i>
                ورود به سامانه
            </h2>

            <!-- خلاصه خطاهای client-side -->
            <div class="validation-summary" id="login-validation-summary"
                 style="display:none;" role="alert" aria-live="polite">
                <div class="validation-summary-header">
                    <i class="material-icons">warning_amber</i>
                    <strong>لطفاً موارد زیر را تکمیل کنید:</strong>
                </div>
                <ul class="validation-summary-list" id="login-validation-list"></ul>
            </div>

            <form method="POST" action="{{ url_for('login') }}" novalidate
                  id="login-form" onsubmit="return validateLoginForm(event)">
                {{ login_form.hidden_tag() }}

                <!-- شماره دانشجویی -->
                <div class="form-group">
                    {{ login_form.student_id.label(class="form-label") }}
                    {{ login_form.student_id(
                        class="form-control" + (" input-error" if login_form.student_id.errors else ""),
                        placeholder="شماره دانشجویی یا admin",
                        id="login-student-id",
                        autocomplete="username"
                    ) }}
                    {% if login_form.student_id.errors %}
                        <div class="field-error" id="err-login-student-id">
                            <i class="material-icons">error_outline</i>
                            {{ login_form.student_id.errors[0] }}
                        </div>
                    {% else %}
                        <div class="field-error" id="err-login-student-id" style="display:none;">
                            <i class="material-icons">error_outline</i>
                            <span></span>
                        </div>
                    {% endif %}
                </div>

                <!-- رمز عبور -->
                <div class="form-group">
                    {{ login_form.password.label(class="form-label") }}
                    <div class="input-with-toggle">
                        {{ login_form.password(
                            class="form-control" + (" input-error" if login_form.password.errors else ""),
                            placeholder="رمز عبور",
                            id="login-password",
                            autocomplete="current-password"
                        ) }}
                        <button type="button" class="toggle-password-btn"
                                onclick="togglePassword('login-password', this)"
                                tabindex="-1" title="نمایش/مخفی کردن رمز">
                            <i class="material-icons">visibility</i>
                        </button>
                    </div>
                    {% if login_form.password.errors %}
                        <div class="field-error" id="err-login-password">
                            <i class="material-icons">error_outline</i>
                            {{ login_form.password.errors[0] }}
                        </div>
                    {% else %}
                        <div class="field-error" id="err-login-password" style="display:none;">
                            <i class="material-icons">error_outline</i>
                            <span></span>
                        </div>
                    {% endif %}
                </div>

                <button type="submit" class="btn btn-custom auth-submit-btn" id="login-submit-btn">
                    <i class="material-icons">login</i>
                    ورود به سامانه
                </button>
            </form>

            <p class="auth-switch-hint">
                حساب کاربری ندارید؟
                <a href="#" onclick="switchTab('register', document.getElementById('tab-btn-register')); return false;">
                    ثبت‌نام کنید
                </a>
            </p>
        </div>
    </div>

</div><!-- /auth-container -->

<style>
/* ── Auth Container ── */
.auth-container {
    max-width: 500px;
    margin: 2rem auto;
    padding: 0 1rem 3rem;
}

/* ── Header ── */
.auth-header { text-align: center; margin-bottom: 2rem; }
.auth-logo {
    width: 70px; height: 70px;
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    border-radius: 20px;
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 1.25rem;
    box-shadow: 0 8px 24px rgba(0,131,143,.3);
}
.auth-logo i { font-size: 2.2rem; color: white; }
.auth-title {
    font-size: 1.85rem; font-weight: 700;
    color: var(--primary-color); margin-bottom: .4rem;
}
.auth-subtitle { color: var(--text-secondary); font-size: .95rem; }

/* ── Flash Alerts ── */
.auth-alert {
    display: flex; align-items: center; gap: .6rem;
    padding: .85rem 1.1rem; border-radius: 10px;
    margin-bottom: 1rem; font-size: .9rem; font-weight: 500;
}
.auth-alert i { font-size: 1.1rem; flex-shrink: 0; }
.auth-alert-success {
    background: rgba(46,125,50,.1); border: 1px solid rgba(46,125,50,.25); color: var(--success);
}
.auth-alert-error {
    background: rgba(183,28,28,.08); border: 1px solid rgba(183,28,28,.2); color: var(--error);
}
.auth-alert-info {
    background: rgba(2,136,209,.08); border: 1px solid rgba(2,136,209,.2); color: var(--info);
}

/* ── Validation Summary ── */
.validation-summary {
    background: rgba(183,28,28,.06);
    border: 1.5px solid rgba(183,28,28,.25);
    border-right: 4px solid var(--error);
    border-radius: 10px;
    padding: .9rem 1.1rem;
    margin-bottom: 1.25rem;
    animation: summarySlideIn .25s ease;
}
@keyframes summarySlideIn {
    from { opacity: 0; transform: translateY(-8px); }
    to   { opacity: 1; transform: translateY(0); }
}
.validation-summary-header {
    display: flex; align-items: center; gap: .4rem;
    color: var(--error); font-size: .92rem; margin-bottom: .55rem;
}
.validation-summary-header i { font-size: 1.1rem; flex-shrink: 0; }
.validation-summary-list {
    list-style: none; margin: 0; padding: 0;
    display: flex; flex-direction: column; gap: .3rem;
}
.validation-summary-list li {
    display: flex; align-items: center; gap: .4rem;
    font-size: .86rem; color: var(--error);
    cursor: pointer; border-radius: 5px;
    padding: .15rem .3rem; transition: background .15s;
}
.validation-summary-list li:hover { background: rgba(183,28,28,.08); }
.validation-summary-list li::before { content: '•'; font-size: 1rem; flex-shrink: 0; }

/* ── Tabs ── */
.auth-tabs {
    display: flex;
    background: var(--surface);
    border: 1px solid var(--border-color);
    border-radius: 14px; padding: 5px;
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow-sm); gap: 4px;
}
.auth-tab {
    flex: 1; text-align: center; padding: .7rem .5rem;
    cursor: pointer; border-radius: 10px;
    font-weight: 600; font-size: .9rem; color: var(--text-secondary);
    transition: all .25s;
    display: flex; align-items: center; justify-content: center; gap: .35rem;
    user-select: none;
}
.auth-tab:hover { background: var(--background); color: var(--primary-color); }
.auth-tab.active {
    background: var(--primary-color); color: white;
    box-shadow: 0 4px 12px rgba(0,131,143,.3);
}

/* ── Tab Content ── */
.auth-tab-content { display: none; animation: authFadeIn .3s ease; }
.auth-tab-content.active { display: block; }
@keyframes authFadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
}

/* ── Form Card ── */
.auth-form-card {
    background: var(--surface); border-radius: 16px;
    padding: 2rem; box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
}
.form-section-title {
    display: flex; align-items: center; gap: .5rem;
    font-size: 1.1rem; font-weight: 700; color: var(--primary-color);
    margin-bottom: 1.5rem; padding-bottom: .85rem;
    border-bottom: 1px solid var(--border-color);
}
.form-section-title i { font-size: 1.2rem; }

/* ── Input با دکمه نمایش رمز ── */
.input-with-toggle { position: relative; display: flex; align-items: center; }
.input-with-toggle .form-control { padding-left: 2.75rem; width: 100%; }
.toggle-password-btn {
    position: absolute; left: .6rem;
    background: none; border: none; cursor: pointer;
    color: var(--text-secondary); padding: .25rem;
    display: flex; align-items: center;
    border-radius: 50%; transition: color .2s; line-height: 1;
}
.toggle-password-btn:hover { color: var(--primary-color); }
.toggle-password-btn i { font-size: 1.15rem; }

/* ── Field Errors ── */
.input-error { border-color: var(--error) !important; }
.input-error.shake { animation: shakeInput .35s ease; }
@keyframes shakeInput {
    0%, 100% { transform: translateX(0); }
    20% { transform: translateX(-5px); }
    40% { transform: translateX(5px); }
    60% { transform: translateX(-4px); }
    80% { transform: translateX(4px); }
}
.field-error {
    display: flex; align-items: center; gap: .3rem;
    color: var(--error); font-size: .82rem; margin-top: .35rem;
}
.field-error i { font-size: .9rem; flex-shrink: 0; }

/* ── Field Hint ── */
.field-hint {
    display: flex; align-items: center; gap: .25rem;
    color: var(--text-secondary); font-size: .78rem; margin-top: .3rem;
}
.field-hint i { font-size: .85rem; }

/* ── Submit Button ── */
.auth-submit-btn {
    width: 100%; margin-top: 1.25rem;
    padding: .85rem; font-size: 1rem; font-weight: 600;
    border-radius: 10px; justify-content: center;
}

/* ── Switch Hint ── */
.auth-switch-hint {
    text-align: center; margin-top: 1.25rem;
    font-size: .88rem; color: var(--text-secondary);
}
.auth-switch-hint a {
    color: var(--primary-color); font-weight: 600; text-decoration: none;
}
.auth-switch-hint a:hover { text-decoration: underline; }
</style>
{% endblock %}

{% block scripts %}
<script>
/* ── switchTab ── */
function switchTab(tabName, tabBtn) {
    document.querySelectorAll('.auth-tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.auth-tab').forEach(el => el.classList.remove('active'));
    const content = document.getElementById(tabName + '-tab');
    if (content) content.classList.add('active');
    if (tabBtn) tabBtn.classList.add('active');
    hideSummary('reg-validation-summary');
    hideSummary('login-validation-summary');
}

/* ── نمایش/مخفی کردن رمز ── */
function togglePassword(inputId, btn) {
    const input = document.getElementById(inputId);
    if (!input) return;
    const icon = btn.querySelector('i');
    if (input.type === 'password') {
        input.type = 'text';
        if (icon) icon.textContent = 'visibility_off';
    } else {
        input.type = 'password';
        if (icon) icon.textContent = 'visibility';
    }
}

/* ── Utility: مدیریت خطاهای فیلد ── */

/**
 * خطا را روی یک فیلد نشان می‌دهد:
 * border قرمز + انیمیشن shake + پیام زیر فیلد
 */
function showFieldError(inputId, errId, message) {
    const input = document.getElementById(inputId);
    const errEl = document.getElementById(errId);
    if (input) {
        input.classList.add('input-error');
        // برای اینکه shake دوباره اجرا شود، ابتدا حذف و بعد اضافه می‌کنیم
        input.classList.remove('shake');
        void input.offsetWidth; // force reflow — بدون این مرورگر تغییر را نمی‌بیند
        input.classList.add('shake');
        setTimeout(() => input.classList.remove('shake'), 400);
    }
    if (errEl) {
        const span = errEl.querySelector('span');
        if (span) span.textContent = message;
        errEl.style.display = 'flex';
    }
}

/** خطای یک فیلد را پاک می‌کند */
function clearFieldError(inputId, errId) {
    const input = document.getElementById(inputId);
    const errEl = document.getElementById(errId);
    if (input) input.classList.remove('input-error');
    if (errEl) errEl.style.display = 'none';
}

/**
 * جعبه خلاصه خطاها را نمایش می‌دهد.
 * کلیک روی هر آیتم، کاربر را مستقیماً به فیلد مربوطه می‌برد.
 */
function showSummary(summaryId, listId, errors) {
    const summary = document.getElementById(summaryId);
    const list = document.getElementById(listId);
    if (!summary || !list) return;
    list.innerHTML = '';
    errors.forEach(function(err) {
        const li = document.createElement('li');
        li.textContent = err.message;
        li.addEventListener('click', function() {
            const field = document.getElementById(err.inputId);
            if (field) {
                field.focus();
                field.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });
        list.appendChild(li);
    });
    summary.style.display = 'block';
    summary.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function hideSummary(summaryId) {
    const el = document.getElementById(summaryId);
    if (el) el.style.display = 'none';
}

/* ── اعتبارسنجی فرم ثبت‌نام ── */
function validateRegisterForm(event) {
    // پاک کردن همه خطاهای قبلی
    clearFieldError('reg-full-name', 'err-full-name');
    clearFieldError('reg-student-id', 'err-student-id');
    clearFieldError('reg-major', 'err-major');
    clearFieldError('reg-password', 'err-password');
    clearFieldError('reg-confirm-password', 'err-confirm-password');
    hideSummary('reg-validation-summary');

    const errors = [];
    let isValid = true;

    // ۱. نام و نام خانوادگی
    const fullName = document.getElementById('reg-full-name');
    if (!fullName || !fullName.value.trim()) {
        showFieldError('reg-full-name', 'err-full-name', 'نام و نام خانوادگی را وارد کنید');
        errors.push({ message: 'نام و نام خانوادگی را وارد کنید', inputId: 'reg-full-name' });
        isValid = false;
    }

    // ۲. شماره دانشجویی — دقیقاً ۱۰ رقم عددی
    const studentId = document.getElementById('reg-student-id');
    if (!studentId || !studentId.value.trim()) {
        showFieldError('reg-student-id', 'err-student-id', 'شماره دانشجویی را وارد کنید');
        errors.push({ message: 'شماره دانشجویی را وارد کنید', inputId: 'reg-student-id' });
        isValid = false;
    } else if (!/^\d{10}$/.test(studentId.value.trim())) {
        showFieldError('reg-student-id', 'err-student-id', 'شماره دانشجویی باید دقیقاً ۱۰ رقم باشد');
        errors.push({ message: 'شماره دانشجویی باید دقیقاً ۱۰ رقم باشد', inputId: 'reg-student-id' });
        isValid = false;
    }

    // ۳. رشته تحصیلی
    const major = document.getElementById('reg-major');
    if (!major || !major.value || major.value === '') {
        showFieldError('reg-major', 'err-major', 'رشته تحصیلی را انتخاب کنید');
        errors.push({ message: 'رشته تحصیلی را انتخاب کنید', inputId: 'reg-major' });
        isValid = false;
    }

    // ۴. رمز عبور — دقیقاً ۱۰ رقم
    const password = document.getElementById('reg-password');
    if (!password || !password.value) {
        showFieldError('reg-password', 'err-password', 'کد ملی (رمز عبور) را وارد کنید');
        errors.push({ message: 'کد ملی (رمز عبور) را وارد کنید', inputId: 'reg-password' });
        isValid = false;
    } else if (!/^\d{10}$/.test(password.value)) {
        showFieldError('reg-password', 'err-password', 'رمز عبور باید دقیقاً ۱۰ رقم باشد');
        errors.push({ message: 'رمز عبور باید دقیقاً ۱۰ رقم باشد', inputId: 'reg-password' });
        isValid = false;
    }

    // ۵. تکرار رمز عبور
    const confirmPassword = document.getElementById('reg-confirm-password');
    if (!confirmPassword || !confirmPassword.value) {
        showFieldError('reg-confirm-password', 'err-confirm-password', 'تکرار رمز عبور را وارد کنید');
        errors.push({ message: 'تکرار رمز عبور را وارد کنید', inputId: 'reg-confirm-password' });
        isValid = false;
    } else if (password && confirmPassword.value !== password.value) {
        showFieldError('reg-confirm-password', 'err-confirm-password', 'رمز عبور و تکرار آن مطابقت ندارند');
        errors.push({ message: 'رمز عبور و تکرار آن مطابقت ندارند', inputId: 'reg-confirm-password' });
        isValid = false;
    }

    if (!isValid) {
        event.preventDefault();
        showSummary('reg-validation-summary', 'reg-validation-list', errors);
        return false;
    }
    return true;
}

/* ── اعتبارسنجی فرم ورود ── */
function validateLoginForm(event) {
    clearFieldError('login-student-id', 'err-login-student-id');
    clearFieldError('login-password', 'err-login-password');
    hideSummary('login-validation-summary');

    const errors = [];
    let isValid = true;

    const studentId = document.getElementById('login-student-id');
    if (!studentId || !studentId.value.trim()) {
        showFieldError('login-student-id', 'err-login-student-id', 'شماره دانشجویی را وارد کنید');
        errors.push({ message: 'شماره دانشجویی را وارد کنید', inputId: 'login-student-id' });
        isValid = false;
    }

    const password = document.getElementById('login-password');
    if (!password || !password.value) {
        showFieldError('login-password', 'err-login-password', 'رمز عبور را وارد کنید');
        errors.push({ message: 'رمز عبور را وارد کنید', inputId: 'login-password' });
        isValid = false;
    }

    if (!isValid) {
        event.preventDefault();
        showSummary('login-validation-summary', 'login-validation-list', errors);
        return false;
    }
    return true;
}

/* ── پاک کردن خطا هنگام تایپ ── */
document.addEventListener('DOMContentLoaded', function () {

    // فیلدهای فرم ثبت‌نام — وقتی کاربر شروع به تایپ می‌کند خطا پاک می‌شود
    [
        ['reg-full-name',        'err-full-name'],
        ['reg-student-id',       'err-student-id'],
        ['reg-major',            'err-major'],
        ['reg-password',         'err-password'],
        ['reg-confirm-password', 'err-confirm-password'],
    ].forEach(function(pair) {
        var input = document.getElementById(pair[0]);
        if (!input) return;
        var eventType = input.tagName === 'SELECT' ? 'change' : 'input';
        input.addEventListener(eventType, function() {
            clearFieldError(pair[0], pair[1]);
        });
    });

    // فیلدهای فرم ورود
    [
        ['login-student-id', 'err-login-student-id'],
        ['login-password',   'err-login-password'],
    ].forEach(function(pair) {
        var input = document.getElementById(pair[0]);
        if (!input) return;
        input.addEventListener('input', function() {
            clearFieldError(pair[0], pair[1]);
        });
    });

    /*
      اگر سرور خطای اعتبارسنجی برگرداند، تب صحیح را به صورت خودکار فعال کن.
      این حالت وقتی پیش می‌آید که JavaScript غیرفعال بوده یا
      خطای server-side رخ داده باشد.
    */
    {% if login_form.errors %}
        switchTab('login', document.getElementById('tab-btn-login'));
    {% endif %}

    {% if form.errors %}
        switchTab('register', document.getElementById('tab-btn-register'));
    {% endif %}
});
</script>
{% endblock %}